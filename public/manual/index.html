<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>パートナー（正規代理店）様向けマニュアルサイト｜営業革命｜ BakuApo</title>
    <meta name="description" content="パートナー（正規代理店）様向けのマニュアルサイトです。動画マニュアル、資料ドライブ、Q&amp;A、お客様への切り返し集を備えています。内容は順次拡充してまいります。">
    <meta name="robots" content="noindex, nofollow">

    <!-- OGP -->
    <meta property="og:title" content="パートナー（正規代理店）様向けマニュアルサイト｜営業革命｜ BakuApo">
    <meta property="og:description" content="パートナー（正規代理店）様向けのマニュアルサイトです。動画マニュアル、資料ドライブ、Q&amp;A、お客様への切り返し集を備えています。内容は順次拡充してまいります。">
    <meta property="og:type" content="website">
    <meta property="og:image" content="/ogp-manual.png">
    <meta property="og:site_name" content="営業革命｜BakuApo">
    <meta property="og:locale" content="ja_JP">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="パートナー（正規代理店）様向けマニュアルサイト｜営業革命｜ BakuApo">
    <meta name="twitter:description" content="パートナー（正規代理店）様向けのマニュアルサイトです。動画マニュアル、資料ドライブ、Q&amp;A、お客様への切り返し集を備えています。内容は順次拡充してまいります。">
    <meta name="twitter:image" content="/ogp-manual.png">

    <link rel="icon" href="/favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Base Variables & Reset --- */
        :root {
            --bg-color: #FAFAFA;
            --card-bg: #FFFFFF;
            --text-main: #171717;
            --text-sub: #6B7280;
            --accent-color: #000000;
            --accent-hover: #333333;
            --link-color: #2563EB;
            --border-color: #E5E7EB;
            --border-subtle: #F3F4F6;
            --tag-bg: #F3F4F6;
            --tag-text: #374151;
            --star-color-on: #EAB308;
            --star-color-off: #D1D5DB;
            --check-color-on: #22C55E;
            --check-color-off: #D1D5DB;
            --sidebar-width: 220px;
            --spacing-unit: 24px;
            --max-width: 1200px;
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
            
            /* アイコン色 */
            --icon-sheet: #22C55E;
            --icon-doc: #3B82F6;
            --icon-slide: #F59E0B;
            --icon-pdf: #EF4444;
            --icon-web: #6B7280;

            /* Chatbot Variables */
            --chat-primary: #171717;
            --chat-bg: #FFFFFF;
            --chat-bubble-user: #171717;
            --chat-text-user: #FFFFFF;
            --chat-bubble-bot: #F3F4F6;
            --chat-text-bot: #171717;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', 'Noto Sans JP', -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            line-height: 1.6;
            font-size: 15px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
        }

        .container {
            max-width: var(--max-width);
            margin: 0 auto;
            padding: 0 var(--spacing-unit);
            min-height: 100vh;
        }

        /* --- Header --- */
        header {
            padding: 16px 0;
            background: rgba(250, 250, 250, 0.8);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--border-color);
        }

        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .logo-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-group img {
            height: 28px;
            width: auto;
            object-fit: contain;
        }

        .logo-divider {
            width: 1px;
            height: 20px;
            background-color: var(--border-color);
        }

        .header-title {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-sub);
            letter-spacing: -0.01em;
        }

        h1 { display: none; }

        /* --- Tabs --- */
        .tabs {
            display: flex;
            gap: 2px;
            background: #F3F4F6;
            border-radius: 10px;
            padding: 3px;
            margin-bottom: 16px;
        }

        .tab-btn {
            flex: 1;
            padding: 8px 12px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-sub);
            border-radius: 8px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: inherit;
            letter-spacing: -0.01em;
        }
        .tab-btn:hover { color: var(--text-main); }
        .tab-btn.active {
            color: var(--text-main);
            background: var(--card-bg);
            box-shadow: 0 1px 3px rgba(0,0,0,0.08), 0 0 0 1px rgba(0,0,0,0.04);
            font-weight: 600;
        }

        /* --- Search & Status --- */
        .controls-wrapper { margin-bottom: 0; }
        .search-container { position: relative; margin-bottom: 12px; }
        .search-input {
            width: 100%;
            padding: 10px 16px 10px 40px;
            font-size: 14px;
            font-family: inherit;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background-color: var(--card-bg);
            color: var(--text-main);
            transition: all 0.2s;
        }
        .search-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.06);
        }
        .search-icon {
            position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
            width: 16px; height: 16px; fill: var(--text-sub); pointer-events: none;
            opacity: 0.5;
        }

        .status-bar {
            display: flex; justify-content: space-between; align-items: center;
            font-size: 12px; color: var(--text-sub); height: 20px;
            margin-bottom: 8px;
        }
        .loading-indicator { display: none; align-items: center; gap: 6px; }
        .loading-indicator.active { display: flex; }
        .spinner {
            width: 12px; height: 12px; border: 2px solid var(--border-color);
            border-top-color: var(--accent-color); border-radius: 50%; animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- Chat Reference Links --- */
        .chat-ref-links {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-top: 10px;
        }
        .chat-ref-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--border-subtle);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-main);
            text-decoration: none;
            transition: all 0.15s;
            line-height: 1.4;
        }
        .chat-ref-btn:hover {
            background: #E5E7EB;
            border-color: #D1D5DB;
        }
        .chat-ref-btn .ref-icon {
            width: 14px;
            height: 14px;
            flex-shrink: 0;
            opacity: 0.5;
        }
        .chat-ref-btn .ref-badge {
            font-size: 10px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 4px;
            flex-shrink: 0;
        }
        .chat-ref-btn .ref-badge.badge-video { background: #DBEAFE; color: #1D4ED8; }
        .chat-ref-btn .ref-badge.badge-drive { background: #D1FAE5; color: #065F46; }
        .chat-ref-btn .ref-badge.badge-qa { background: #FEF3C7; color: #92400E; }
        .chat-ref-btn .ref-badge.badge-rebuttal { background: #FCE7F3; color: #9D174D; }

        /* --- Initial Loading Overlay --- */
        .initial-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 80px 20px;
            gap: 20px;
        }
        .initial-loading .loading-spinner {
            width: 32px;
            height: 32px;
            border: 2px solid var(--border-color);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }
        .initial-loading .loading-text {
            font-size: 13px;
            color: var(--text-sub);
            font-weight: 500;
        }
        .skeleton-list {
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 8px;
        }
        .skeleton-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 20px;
        }
        .skeleton-line {
            height: 12px;
            background: linear-gradient(90deg, #F3F4F6 25%, #FAFAFA 50%, #F3F4F6 75%);
            background-size: 200% 100%;
            animation: skeleton-shimmer 1.8s ease-in-out infinite;
            border-radius: 6px;
            margin-bottom: 10px;
        }
        .skeleton-line:last-child { margin-bottom: 0; }
        .skeleton-line.short { width: 40%; }
        .skeleton-line.medium { width: 65%; }
        .skeleton-line.long { width: 100%; }
        .skeleton-line.title { height: 16px; width: 50%; margin-bottom: 14px; }
        @keyframes skeleton-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        @keyframes skeleton-shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* --- Layout --- */
        .main-layout {
            display: flex; gap: 32px; position: relative; align-items: flex-start;
            padding-top: 8px;
        }

        .sidebar {
            width: var(--sidebar-width); flex-shrink: 0; position: sticky;
            max-height: calc(100vh - 200px); overflow-y: auto; padding-right: 8px;
            background-color: transparent;
        }
        .sidebar::-webkit-scrollbar { width: 3px; }
        .sidebar::-webkit-scrollbar-thumb { background-color: rgba(0,0,0,0.08); border-radius: 4px; }

        .filter-section {
            margin-bottom: 20px; padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex; flex-direction: column; gap: 6px;
        }
        .filter-btn {
            display: flex; align-items: center; gap: 8px; width: 100%; padding: 7px 10px;
            background: var(--card-bg); border: 1px solid var(--border-color); border-radius: var(--radius-sm);
            cursor: pointer; font-size: 13px; font-weight: 500; color: var(--text-main);
            transition: all 0.15s; user-select: none; font-family: inherit;
        }
        .filter-btn:hover { background: var(--border-subtle); }
        .filter-btn.active-star { background: #FFFBEB; border-color: #FDE68A; color: #92400E; }
        .filter-btn.active-star svg { fill: #EAB308; stroke: #EAB308; }
        .filter-btn.active-unwatched { background: #F0FDF4; border-color: #86EFAC; color: #166534; }
        .filter-icon { width: 16px; height: 16px; fill: none; stroke: currentColor; stroke-width: 2; }

        .sidebar-title {
            font-size: 11px; font-weight: 600; text-transform: uppercase; color: var(--text-sub);
            margin-bottom: 8px; padding-left: 8px; letter-spacing: 0.05em;
        }
        .category-nav-list { list-style: none; }
        .category-nav-item {
            font-size: 13px; color: var(--text-sub); padding: 5px 8px;
            border-radius: var(--radius-sm); cursor: pointer; transition: all 0.1s;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            font-weight: 500;
        }
        .category-nav-item:hover { background-color: var(--border-subtle); color: var(--text-main); }

        .content-area { flex: 1; padding-bottom: 80px; min-width: 0; }
        .list-section { display: none; flex-direction: column; gap: 20px; }
        .list-section.active { display: flex; }

        /* --- Video Card Design --- */
        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.04);
            scroll-margin-top: 280px;
            position: relative;
            transition: box-shadow 0.2s;
        }
        .card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
        }

        .category-badge {
            display: inline-block;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-sub);
            background: var(--border-subtle);
            padding: 3px 10px;
            border-radius: 20px;
            margin-bottom: 12px;
            letter-spacing: 0.01em;
        }

        /* --- Drive File List Design --- */
        .drive-category-group { 
            margin-bottom: 32px; 
            scroll-margin-top: 280px; 
        }
        .drive-category-title {
            font-size: 18px; font-weight: 700; margin-bottom: 20px;
            padding-bottom: 8px; border-bottom: 1px solid var(--border-color);
            color: var(--text-main); letter-spacing: -0.02em;
        }
        
        .drive-medium-block {
            margin-bottom: 20px;
            margin-left: 4px;
            padding-left: 16px;
            border-left: 2px solid var(--border-color);
        }
        
        .drive-medium-header {
            font-size: 15px; font-weight: 600; color: var(--text-main);
            display: flex; align-items: center; gap: 8px;
            margin-bottom: 10px;
            padding-top: 4px;
        }
        .folder-icon { width: 18px; height: 18px; fill: var(--text-sub); opacity: 0.6; }

        .drive-small-group {
            margin-left: 8px;
            margin-bottom: 14px;
        }

        .drive-small-header {
            font-size: 13px; font-weight: 600; color: var(--text-sub);
            display: flex; align-items: center; gap: 6px;
            margin-bottom: 8px;
        }
        .small-icon { width: 12px; height: 12px; }

        .drive-file-list { 
            list-style: none; 
            margin-left: 8px;
            display: flex; flex-direction: column; gap: 6px;
        }
        .drive-file-list.direct-list { margin-left: 4px; margin-bottom: 20px; }

        .drive-file-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 14px; 
            background: var(--card-bg); border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            transition: all 0.15s; text-decoration: none; color: inherit;
        }
        .drive-file-item:hover { 
            border-color: #D1D5DB;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        .file-content-wrapper { display: flex; gap: 12px; flex: 1; min-width: 0; align-items: center; }
        
        .file-thumbnail {
            width: 44px; height: 44px; 
            background-color: var(--border-subtle); border-radius: var(--radius-sm);
            flex-shrink: 0; display: flex; align-items: center; justify-content: center;
            overflow: hidden;
        }
        .file-thumbnail img { width: 100%; height: 100%; object-fit: cover; }
        
        .icon-svg { width: 24px; height: 24px; }
        .type-sheet { color: var(--icon-sheet); }
        .type-doc { color: var(--icon-doc); }
        .type-pdf { color: var(--icon-pdf); }
        .type-slide { color: var(--icon-slide); }
        .type-web { color: var(--icon-web); }

        .file-info { display: flex; flex-direction: column; gap: 1px; justify-content: center; }
        .file-name {
            font-size: 14px; color: var(--text-main); font-weight: 500;
            line-height: 1.4;
        }
        .file-desc {
            font-size: 12px; color: var(--text-sub); line-height: 1.4;
        }
        
        .drive-file-item:hover .file-name { color: var(--link-color); }

        .action-buttons {
            display: flex; gap: 2px; margin-left: 8px; flex-shrink: 0;
        }
        .card .action-buttons { position: absolute; top: 20px; right: 20px; }

        .icon-btn {
            background: none; border: none; cursor: pointer; padding: 4px;
            display: flex; align-items: center; justify-content: center;
            color: var(--star-color-off); transition: all 0.1s;
            border-radius: 6px;
        }
        .icon-btn:hover { background: var(--border-subtle); transform: scale(1.1); }
        .icon-btn svg { width: 18px; height: 18px; fill: none; stroke: currentColor; stroke-width: 2; }
        
        .star-btn.active { color: var(--star-color-on); }
        .star-btn.active svg { fill: currentColor; stroke: currentColor; }

        .check-btn { color: var(--check-color-off); }
        .check-btn.active { color: var(--check-color-on); }
        
        .video-title { font-size: 17px; font-weight: 700; margin-bottom: 14px; padding-right: 80px; letter-spacing: -0.01em; }
        .video-embed-container {
            position: relative; width: 100%; padding-bottom: 56.25%;
            background-color: #000; border-radius: var(--radius-md); overflow: hidden; margin-bottom: 14px;
        }
        .video-embed-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
        .description { font-size: 14px; white-space: pre-wrap; margin-bottom: 14px; word-wrap: break-word; color: var(--text-sub); line-height: 1.7; }
        .material-btn {
            display: inline-flex; align-items: center; gap: 6px; font-size: 13px; color: var(--text-sub);
            background-color: var(--border-subtle); padding: 7px 12px; border-radius: var(--radius-sm); text-decoration: none;
            font-weight: 500; transition: all 0.15s; border: 1px solid var(--border-color);
        }
        .material-btn:hover { background-color: #E5E7EB; color: var(--text-main); }

        /* --- Q&A Card Design --- */
        .qa-card {
            background-color: var(--card-bg); border: 1px solid var(--border-color);
            border-radius: var(--radius-lg); padding: 0; margin-bottom: 12px;
            overflow: hidden; transition: box-shadow 0.2s;
        }
        .qa-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .qa-question {
            display: flex; align-items: flex-start; gap: 12px; padding: 18px 20px;
            font-weight: 600; font-size: 14px; line-height: 1.6;
            background-color: var(--border-subtle); border-bottom: 1px solid var(--border-color);
            position: relative;
        }
        .qa-question .action-buttons { position: absolute; top: 14px; right: 14px; }
        .qa-answer {
            display: flex; align-items: flex-start; gap: 12px; padding: 18px 20px;
            font-size: 14px; line-height: 1.8; white-space: pre-wrap; color: var(--text-main);
        }
        .qa-badge {
            flex-shrink: 0; display: inline-flex; align-items: center; justify-content: center;
            width: 26px; height: 26px; border-radius: 8px; font-size: 12px; font-weight: 700;
            margin-top: 1px;
        }
        .qa-badge-q { background-color: var(--accent-color); color: #fff; }
        .qa-badge-a { background-color: var(--check-color-on); color: #fff; }

        /* --- Rebuttal Card Design --- */
        .rebuttal-card { border-left: 3px solid #EF4444; }
        .rebuttal-objection { background-color: #FEF2F2; }
        .rebuttal-badge-obj { background-color: #EF4444; color: #fff; font-size: 10px; width: auto; padding: 3px 8px; border-radius: 6px; }
        .rebuttal-badge-res { background-color: var(--accent-color); color: #fff; font-size: 10px; width: auto; padding: 3px 8px; border-radius: 6px; }

        .message-state { text-align: center; padding: 48px; color: var(--text-sub); font-size: 14px; }
        .error-container { display: none; flex-direction: column; gap: 8px; margin-bottom: 20px; }
        .error-message { color: #DC2626; background: #FEF2F2; padding: 12px 16px; border-radius: var(--radius-md); font-size: 13px; border: 1px solid #FECACA; }

        /* --- Chatbot Widget Styles --- */
        .chat-widget {
            position: fixed; bottom: 24px; right: 24px; z-index: 1000;
            display: flex; flex-direction: column; align-items: flex-end;
            font-family: inherit;
        }
        .chat-toggle-btn {
            height: 48px; padding: 0 20px 0 16px; border-radius: 24px;
            background-color: var(--chat-primary); color: white; border: none;
            box-shadow: 0 4px 16px rgba(0,0,0,0.12); cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: all 0.2s; font-weight: 600; font-size: 13px; font-family: inherit;
        }
        .chat-toggle-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.18); }
        .chat-toggle-btn svg { width: 20px; height: 20px; fill: currentColor; }
        .chat-btn-text { display: block; }

        .chat-window {
            position: absolute; bottom: 64px; right: 0; width: 360px; height: 500px;
            background-color: var(--chat-bg); border-radius: var(--radius-lg);
            box-shadow: 0 16px 48px rgba(0,0,0,0.12), 0 0 0 1px rgba(0,0,0,0.06);
            display: none; flex-direction: column; overflow: hidden;
            transform-origin: bottom right;
        }
        .chat-window.active { display: flex; }

        .chat-header {
            padding: 14px 16px;
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
        }
        .chat-title { font-weight: 600; font-size: 14px; color: var(--text-main); }
        .chat-close {
            background: none; border: none; cursor: pointer; color: var(--text-sub);
            width: 28px; height: 28px; border-radius: 6px; display: flex; align-items: center; justify-content: center;
            transition: background 0.15s; font-size: 16px;
        }
        .chat-close:hover { background: var(--border-subtle); }

        .chat-messages {
            flex: 1; padding: 16px; overflow-y: auto; background-color: var(--card-bg);
            display: flex; flex-direction: column; gap: 10px;
        }
        .chat-msg {
            max-width: 85%; padding: 10px 14px; border-radius: var(--radius-md); font-size: 13px; line-height: 1.6; word-wrap: break-word;
        }
        .chat-msg.bot { align-self: flex-start; background-color: var(--chat-bubble-bot); color: var(--chat-text-bot); border-bottom-left-radius: 2px; }
        .chat-msg.user { align-self: flex-end; background-color: var(--chat-bubble-user); color: var(--chat-text-user); border-bottom-right-radius: 2px; }
        .chat-msg.system { align-self: center; background-color: #FEF2F2; color: #DC2626; border: 1px solid #FECACA; font-size: 12px; text-align: left; max-width: 90%; }
        .chat-msg b, .chat-msg strong { font-weight: 700; }
        .chat-msg a { color: var(--link-color); text-decoration: underline; text-underline-offset: 2px; word-break: break-all; }
        .chat-msg a:hover { text-decoration: none; }

        .chat-input-area {
            padding: 12px; border-top: 1px solid var(--border-color);
            display: flex; gap: 8px; background-color: var(--card-bg);
        }
        .chat-input {
            flex: 1; padding: 9px 14px; border: 1px solid var(--border-color); border-radius: 20px;
            font-size: 13px; outline: none; transition: all 0.2s; font-family: inherit;
        }
        .chat-input:focus { border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(0,0,0,0.04); }
        .chat-input:disabled { background-color: var(--border-subtle); cursor: not-allowed; }
        .chat-send-btn { background: none; border: none; cursor: pointer; color: var(--accent-color); padding: 4px; }
        .chat-send-btn:disabled { color: var(--text-sub); cursor: not-allowed; }

        .typing-dots { display: flex; gap: 4px; padding: 4px 8px; }
        .typing-dot { width: 5px; height: 5px; background-color: #9CA3AF; border-radius: 50%; animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* --- Responsive --- */
        @media (max-width: 768px) {
            .container { padding: 0 16px; }
            header { padding: 12px 0; }
            .header-top { margin-bottom: 12px; }
            .logo-group img { height: 22px; }
            .header-title { font-size: 11px; }
            .tabs { margin-bottom: 12px; }
            .tab-btn { font-size: 12px; padding: 7px 8px; }
            .status-bar { display: none; }
            .main-layout { flex-direction: column; gap: 12px; padding-top: 4px; }
            .sidebar {
                position: sticky; z-index: 90; width: calc(100% + 32px); margin-left: -16px;
                padding: 8px 16px; border-bottom: 1px solid var(--border-color);
                max-height: none; overflow-x: auto; display: flex; align-items: center; gap: 6px;
                background: rgba(250, 250, 250, 0.9);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
            }
            .sidebar::-webkit-scrollbar { display: none; }
            .filter-section {
                flex-direction: row; margin: 0; padding: 0; border: none;
                padding-right: 6px; margin-right: 4px; border-right: 1px solid var(--border-color);
            }
            .filter-btn { padding: 5px 8px; width: auto; font-size: 11px; white-space: nowrap; }
            .sidebar-title { display: none; }
            .category-nav-list { display: flex; gap: 6px; }
            .category-nav-item { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 20px; padding: 5px 12px; font-size: 11px; }
            .card { scroll-margin-top: 240px; padding: 18px; }
            .drive-category-group { scroll-margin-top: 240px; }
            .drive-medium-block { margin-left: 0; padding-left: 12px; }
            .drive-file-list { margin-left: 0; }
            .file-thumbnail { width: 38px; height: 38px; }
            .file-name { font-size: 13px; }
            .icon-svg { width: 20px; height: 20px; }
            .video-title { font-size: 15px; padding-right: 60px; }
            .chat-toggle-btn { width: 48px; height: 48px; border-radius: 50%; padding: 0; }
            .chat-btn-text { display: none; }
            .chat-window { width: calc(100vw - 24px); right: -8px; bottom: 64px; height: 60vh; }
        }
    </style>
</head>
<body>

<div class="container">
    <header id="mainHeader">
        <div class="header-top">
            <div class="logo-group">
                <img src="/eigyou-kakumei_logo.svg" alt="営業革命" onerror="this.style.display='none'">
                <div class="logo-divider"></div>
                <img src="/bakuapo-logo.svg" alt="BakuApo" onerror="this.style.display='none'">
            </div>
            <span class="header-title">パートナー様向けマニュアル</span>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('video')" data-tab="video">動画マニュアル</button>
            <button class="tab-btn" onclick="switchTab('drive')" data-tab="drive">資料ドライブ</button>
            <button class="tab-btn" onclick="switchTab('qa')" data-tab="qa">Q&A</button>
            <button class="tab-btn" onclick="switchTab('rebuttal')" data-tab="rebuttal">切り返し集</button>
        </div>

        <div class="controls-wrapper">
            <div class="search-container">
                <svg class="search-icon" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                <input type="text" id="searchInput" class="search-input" placeholder="検索...">
            </div>
            <div id="errorContainer" class="error-container"></div>
            <div class="status-bar">
                <span id="countDisplay">0件</span>
                <div class="loading-indicator" id="loadingIndicator"><div class="spinner"></div><span>更新中...</span></div>
            </div>
        </div>
    </header>

    <div class="main-layout">
        <aside class="sidebar" id="stickySidebar">
            <div class="filter-section">
                <div class="filter-btn" id="starFilterBtn" onclick="toggleStarFilter()">
                    <svg class="filter-icon" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                    <span>スター付きのみ</span>
                </div>
                <div class="filter-btn" id="unwatchedFilterBtn" onclick="toggleUnwatchedFilter()">
                    <svg class="filter-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                    <span id="unwatchedText">未視聴のみ表示</span>
                </div>
            </div>
            <div class="sidebar-title">カテゴリー目次</div>
            <ul class="category-nav-list" id="categoryNav"></ul>
        </aside>

        <main class="content-area">
            <div id="list-video" class="list-section active"><div class="initial-loading"><div class="loading-spinner"></div><div class="loading-text">データを読み込んでいます...</div><div class="skeleton-list"><div class="skeleton-card"><div class="skeleton-line title"></div><div class="skeleton-line long"></div><div class="skeleton-line medium"></div></div><div class="skeleton-card"><div class="skeleton-line title"></div><div class="skeleton-line long"></div><div class="skeleton-line short"></div></div><div class="skeleton-card"><div class="skeleton-line title"></div><div class="skeleton-line medium"></div><div class="skeleton-line long"></div></div></div></div></div>
            <div id="list-drive" class="list-section"><div class="initial-loading"><div class="loading-spinner"></div><div class="loading-text">データを読み込んでいます...</div><div class="skeleton-list"><div class="skeleton-card"><div class="skeleton-line title"></div><div class="skeleton-line long"></div><div class="skeleton-line medium"></div></div><div class="skeleton-card"><div class="skeleton-line title"></div><div class="skeleton-line long"></div><div class="skeleton-line short"></div></div></div></div></div>
            <div id="list-qa" class="list-section"><div class="initial-loading"><div class="loading-spinner"></div><div class="loading-text">データを読み込んでいます...</div><div class="skeleton-list"><div class="skeleton-card"><div class="skeleton-line title"></div><div class="skeleton-line long"></div><div class="skeleton-line medium"></div></div><div class="skeleton-card"><div class="skeleton-line title"></div><div class="skeleton-line long"></div><div class="skeleton-line short"></div></div></div></div></div>
            <div id="list-rebuttal" class="list-section"><div class="initial-loading"><div class="loading-spinner"></div><div class="loading-text">データを読み込んでいます...</div><div class="skeleton-list"><div class="skeleton-card"><div class="skeleton-line title"></div><div class="skeleton-line long"></div><div class="skeleton-line medium"></div></div><div class="skeleton-card"><div class="skeleton-line title"></div><div class="skeleton-line long"></div><div class="skeleton-line short"></div></div></div></div></div>
        </main>
    </div>

    <div class="chat-widget">
        <button class="chat-toggle-btn" onclick="toggleChat()" title="AIアシスタントに質問">
            <svg viewBox="0 0 24 24"><path d="M20 9V7c0-1.1-.9-2-2-2h-3c0-1.66-1.34-3-3-3S9 3.34 9 5H6c-1.1 0-2 .9-2 2v2c-1.66 0-3 1.34-3 3s1.34 3 3 3v4c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-4c1.66 0 3-1.34 3-3s-1.34-3-3-3zm-2 10H6v-4h12v4zm0-6H6V7h12v6z"/><circle cx="8.5" cy="10.5" r="1.5"/><circle cx="15.5" cy="10.5" r="1.5"/></svg>
            <span class="chat-btn-text">AIに質問する</span>
        </button>

        <div class="chat-window" id="chatWindow">
            <div class="chat-header">
                <span class="chat-title">AIパートナーアシスタント</span>
                <button class="chat-close" onclick="toggleChat()">✕</button>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="chat-msg bot">
                    こんにちは！<br>動画マニュアル、資料、Q&A、切り返しトークについて、ご質問があればお答えします。
                </div>
            </div>
            <div class="chat-input-area">
                <input type="text" id="chatInput" class="chat-input" placeholder="質問を入力..." onkeypress="handleChatKey(event)">
                <button class="chat-send-btn" onclick="sendChatMessage()" id="chatSendBtn">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    const CONFIG = {
        geminiApiKey: "AIzaSyBxxrrp9_VZaToi63RHLij2xGg8Aov1vWo", 
        // 表示用データソース
        videoSheetUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBVuXb-cTydLU-CMFwHyYnsJfg9e2AsTEa4TU1G9nYQlShkZHv3wGM2a1X5ww81o5v8HZNS9IXUI1b/pub?gid=396280088&single=true&output=csv",
        driveSheetUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBVuXb-cTydLU-CMFwHyYnsJfg9e2AsTEa4TU1G9nYQlShkZHv3wGM2a1X5ww81o5v8HZNS9IXUI1b/pub?gid=380310918&single=true&output=csv",
        
        // Q&A・切り返し集データソース
        qaSheetUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBVuXb-cTydLU-CMFwHyYnsJfg9e2AsTEa4TU1G9nYQlShkZHv3wGM2a1X5ww81o5v8HZNS9IXUI1b/pub?gid=1192474135&single=true&output=csv",
        rebuttalSheetUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBVuXb-cTydLU-CMFwHyYnsJfg9e2AsTEa4TU1G9nYQlShkZHv3wGM2a1X5ww81o5v8HZNS9IXUI1b/pub?gid=1328585848&single=true&output=csv",

        refreshInterval: 60000 
    };

    const THRESHOLDS = { CONFIDENCE: 0.6, SUGGESTION: 0.25 };

    const state = {
        currentTab: 'video',
        searchText: '',
        showStarredOnly: false,
        showUnwatchedOnly: false,
        starredItems: new Set(),
        watchedItems: new Set(),
        data: { video: [], drive: [], qa: [], rebuttal: [] },
        isLoaded: { video: false, drive: false, qa: false, rebuttal: false },
        hasError: false,
        // Chat
        chatHistory: [],
        messageTimestamps: [],
        lockedUntil: 0
    };

    const els = {
        tabs: document.querySelectorAll('.tab-btn'),
        input: document.getElementById('searchInput'),
        count: document.getElementById('countDisplay'),
        loading: document.getElementById('loadingIndicator'),
        errorContainer: document.getElementById('errorContainer'),
        categoryNav: document.getElementById('categoryNav'),
        header: document.getElementById('mainHeader'),
        sidebar: document.getElementById('stickySidebar'),
        starFilterBtn: document.getElementById('starFilterBtn'),
        unwatchedFilterBtn: document.getElementById('unwatchedFilterBtn'),
        unwatchedText: document.getElementById('unwatchedText'),
        lists: {
            video: document.getElementById('list-video'),
            drive: document.getElementById('list-drive'),
            qa: document.getElementById('list-qa'),
            rebuttal: document.getElementById('list-rebuttal')
        },
        // Chat
        chatWindow: document.getElementById('chatWindow'),
        chatMessages: document.getElementById('chatMessages'),
        chatInput: document.getElementById('chatInput'),
        chatSendBtn: document.getElementById('chatSendBtn')
    };

    function updateLayoutMetrics() {
        const headerHeight = els.header.offsetHeight;
        const isMobile = window.innerWidth <= 768;
        const topOffset = isMobile ? headerHeight : headerHeight + 20;
        els.sidebar.style.top = `${topOffset}px`;
        const totalStickyHeight = isMobile ? topOffset + els.sidebar.offsetHeight + 20 : topOffset;
        document.querySelectorAll('.card, .drive-category-group').forEach(el => {
            el.style.scrollMarginTop = `${totalStickyHeight}px`;
        });
    }

    function loadUserPreferences() {
        try {
            const stars = localStorage.getItem('partner_manual_stars_v2');
            if (stars) state.starredItems = new Set(JSON.parse(stars));
            const watched = localStorage.getItem('partner_manual_watched_v2');
            if (watched) state.watchedItems = new Set(JSON.parse(watched));
        } catch (e) {}
    }

    function saveUserPreferences() {
        localStorage.setItem('partner_manual_stars_v2', JSON.stringify([...state.starredItems]));
        localStorage.setItem('partner_manual_watched_v2', JSON.stringify([...state.watchedItems]));
    }

    function switchTab(tab) {
        state.currentTab = tab;
        els.tabs.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tab));
        Object.keys(els.lists).forEach(key => {
            els.lists[key].classList.toggle('active', key === tab);
        });
        const labelMap = { video: '未視聴のみ表示', drive: '未確認のみ表示', qa: '未確認のみ表示', rebuttal: '未確認のみ表示' };
        els.unwatchedText.textContent = labelMap[tab] || '未確認のみ表示';
        renderView();
    }

    function toggleStar(key) {
        if (state.starredItems.has(key)) state.starredItems.delete(key);
        else state.starredItems.add(key);
        saveUserPreferences();
        renderView();
    }

    function toggleWatched(key) {
        if (state.watchedItems.has(key)) state.watchedItems.delete(key);
        else state.watchedItems.add(key);
        saveUserPreferences();
        renderView();
    }

    function toggleStarFilter() {
        state.showStarredOnly = !state.showStarredOnly;
        els.starFilterBtn.classList.toggle('active-star', state.showStarredOnly);
        renderView();
    }

    function toggleUnwatchedFilter() {
        state.showUnwatchedOnly = !state.showUnwatchedOnly;
        els.unwatchedFilterBtn.classList.toggle('active-unwatched', state.showUnwatchedOnly);
        renderView();
    }

    function parseCSV(text) {
        const arr = []; let quote = false; let row = []; let col = ''; let c = 0;
        for (; c < text.length; c++) {
            let cc = text[c], nc = text[c+1];
            if (quote) {
                if (cc === '"') { if (nc === '"') { col += '"'; c++; } else { quote = false; } } else { col += cc; }
            } else {
                if (cc === '"') { quote = true; }
                else if (cc === ',') { row.push(col); col = ''; }
                else if (cc === '\r' && nc === '\n') { row.push(col); col = ''; arr.push(row); row = []; c++; }
                else if (cc === '\n' || cc === '\r') { row.push(col); col = ''; arr.push(row); row = []; }
                else { col += cc; }
            }
        }
        if (col.length > 0 || row.length > 0) { row.push(col); arr.push(row); }
        return arr;
    }

    function extractYoutubeId(url) {
        if (!url) return null;
        const match = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/);
        return (match && match[2].length === 11) ? match[2] : null;
    }

    function getFileType(url) {
        if (!url) return 'web';
        const lower = url.toLowerCase();
        if (extractYoutubeId(url)) return 'youtube';
        if (lower.includes('spreadsheets')) return 'sheet';
        if (lower.includes('document')) return 'doc';
        if (lower.includes('presentation')) return 'slide';
        if (lower.endsWith('.pdf') || lower.includes('drive.google.com')) return 'pdf';
        return 'web';
    }

    function getFileIconSvg(type) {
        let className = 'icon-svg';
        let svgPath = '';
        switch(type) {
            case 'sheet': className += ' type-sheet'; svgPath = '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/>'; break;
            case 'doc': className += ' type-doc'; svgPath = '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/>'; break;
            case 'slide': className += ' type-slide'; svgPath = '<rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/>'; break;
            case 'pdf': className += ' type-pdf'; svgPath = '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><path d="M9 13v-1h3v1"/><path d="M12 18v-6"/><path d="M9 17h3"/>'; break;
            default: className += ' type-web'; svgPath = '<circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>'; break;
        }
        return `<svg class="${className}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">${svgPath}</svg>`;
    }

    async function fetchAllData() {
        els.loading.classList.add('active');
        els.errorContainer.style.display = 'none';

        try {
            // 1. Video (Manual)
            const vRes = await fetch(`${CONFIG.videoSheetUrl}&t=${Date.now()}`);
            if (vRes.ok) {
                const vText = await vRes.text();
                const vRows = parseCSV(vText).slice(1).filter(r => (r[0]||'').toUpperCase() === 'ON');
                state.data.video = vRows.map(r => ({
                    sourceType: 'manual',
                    id: r[2] || r[3],
                    category: r[1] || '未分類',
                    youtubeUrl: r[2], title: r[3], desc: r[4], materialUrl: r[5]
                }));
                state.isLoaded.video = true;
            }

            // 2. Drive (Material)
            const dRes = await fetch(`${CONFIG.driveSheetUrl}&t=${Date.now()}`);
            if (dRes.ok) {
                const dText = await dRes.text();
                const dRows = parseCSV(dText).slice(1).filter(r => (r[0]||'').toUpperCase() === 'ON');
                state.data.drive = dRows.map(r => ({
                    sourceType: 'material',
                    id: r[5] || '#',
                    large: r[1] || 'その他', medium: r[2] || '', small: r[3] || '', detail: r[4] || '',
                    url: r[5] || '#', desc: r[6] || ''
                }));
                state.isLoaded.drive = true;
            }

            // 3. QA (Background for AI)
            const qRes = await fetch(`${CONFIG.qaSheetUrl}&t=${Date.now()}`);
            if (qRes.ok) {
                const qText = await qRes.text();
                const qRows = parseCSV(qText).slice(1).filter(r => (r[0]||'').toUpperCase() === 'ON');
                state.data.qa = qRows.map((r, i) => ({
                    sourceType: 'qa',
                    id: `qa-${r[2] || i}`,
                    category: r[1] || '未分類', question: r[2] || '', answer: r[3] || ''
                }));
                state.isLoaded.qa = true;
            }

            // 4. Rebuttal (Background for AI)
            const rRes = await fetch(`${CONFIG.rebuttalSheetUrl}&t=${Date.now()}`);
            if (rRes.ok) {
                const rText = await rRes.text();
                const rRows = parseCSV(rText).slice(1).filter(r => (r[0]||'').toUpperCase() === 'ON');
                state.data.rebuttal = rRows.map((r, i) => ({
                    sourceType: 'qa', // Treat as QA for AI
                    id: `rebuttal-${r[2] || i}`,
                    category: r[1] || '未分類', question: r[2] || '', answer: r[3] || ''
                }));
                state.isLoaded.rebuttal = true;
            }

        } catch (e) {
            console.error(e);
            state.hasError = true;
            els.errorContainer.style.display = 'flex';
            els.errorContainer.innerHTML = `<div class="error-message">データの更新に失敗しました。</div>`;
        }
        
        renderView();
        els.loading.classList.remove('active');
    }

    function renderView() {
        const tab = state.currentTab;
        const container = els.lists[tab];
        container.innerHTML = '';
        els.categoryNav.innerHTML = '';

        const sourceData = state.data[tab];
        const query = state.searchText.toLowerCase().trim();
        
        if (!state.isLoaded[tab]) {
            container.innerHTML = `<div class="initial-loading"><div class="loading-spinner"></div><div class="loading-text">データを読み込んでいます...</div><div class="skeleton-list"><div class="skeleton-card"><div class="skeleton-line title"></div><div class="skeleton-line long"></div><div class="skeleton-line medium"></div></div><div class="skeleton-card"><div class="skeleton-line title"></div><div class="skeleton-line long"></div><div class="skeleton-line short"></div></div></div></div>`;
            return;
        }

        const filtered = sourceData.filter(item => {
            if (state.showStarredOnly && !state.starredItems.has(item.id)) return false;
            if (state.showUnwatchedOnly && state.watchedItems.has(item.id)) return false;
            if (!query) return true;
            return JSON.stringify(item).toLowerCase().includes(query);
        });

        els.count.textContent = `${filtered.length}件`;

        if (filtered.length === 0) {
            container.innerHTML = `<div class="message-state">該当なし</div>`;
            return;
        }

        if (tab === 'video') {
            renderVideoList(filtered, container);
        } else if (tab === 'drive') {
            renderDriveList(filtered, container);
        } else if (tab === 'qa') {
            renderQAList(filtered, container);
        } else if (tab === 'rebuttal') {
            renderRebuttalList(filtered, container);
        }

        requestAnimationFrame(updateLayoutMetrics);
    }

    function renderVideoList(items, container) {
        const categories = new Set();
        const catMap = {};
        items.forEach((item, idx) => {
            const card = document.createElement('article');
            card.className = 'card';
            card.id = `video-${idx}`;
            if (!categories.has(item.category)) {
                categories.add(item.category);
                catMap[item.category] = card.id;
            }
            card.innerHTML += `<div class="category-badge">${item.category}</div>`;
            const actions = createActionButtons(item.id, 'video');
            card.appendChild(actions);
            const h3 = document.createElement('h3');
            h3.className = 'video-title';
            h3.textContent = item.title;
            card.appendChild(h3);
            const vidId = extractYoutubeId(item.youtubeUrl);
            if (vidId) {
                card.innerHTML += `<div class="video-embed-container"><iframe src="https://www.youtube.com/embed/${vidId}" loading="lazy" allowfullscreen></iframe></div>`;
            }
            if (item.desc) card.innerHTML += `<div class="description">${item.desc}</div>`;
            if (item.materialUrl) {
                card.innerHTML += `<a href="${item.materialUrl}" target="_blank" class="material-btn"><svg viewBox="0 0 24 24" class="filter-icon"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg><span>テキスト資料</span></a>`;
            }
            container.appendChild(card);
        });
        renderNav(categories, catMap);
    }

    function renderQAList(items, container) {
        const categories = new Set();
        const catMap = {};
        const grouped = {};
        items.forEach(item => {
            const cat = item.category || '未分類';
            if (!grouped[cat]) grouped[cat] = [];
            grouped[cat].push(item);
        });
        let idx = 0;
        Object.keys(grouped).forEach(cat => {
            categories.add(cat);
            const catId = `qa-cat-${idx++}`;
            catMap[cat] = catId;
            const section = document.createElement('div');
            section.className = 'drive-category-group';
            section.id = catId;
            section.innerHTML = `<h2 class="drive-category-title">${cat}</h2>`;
            grouped[cat].forEach(item => {
                const card = document.createElement('div');
                card.className = 'qa-card';
                const actions = createActionButtons(item.id, 'qa');
                card.innerHTML = `
                    <div class="qa-question"><span class="qa-badge qa-badge-q">Q</span><span>${item.question}</span></div>
                    <div class="qa-answer"><span class="qa-badge qa-badge-a">A</span><span>${item.answer}</span></div>
                `;
                card.querySelector('.qa-question').appendChild(actions);
                section.appendChild(card);
            });
            container.appendChild(section);
        });
        renderNav(categories, catMap);
    }

    function renderRebuttalList(items, container) {
        const categories = new Set();
        const catMap = {};
        const grouped = {};
        items.forEach(item => {
            const cat = item.category || '未分類';
            if (!grouped[cat]) grouped[cat] = [];
            grouped[cat].push(item);
        });
        let idx = 0;
        Object.keys(grouped).forEach(cat => {
            categories.add(cat);
            const catId = `rebuttal-cat-${idx++}`;
            catMap[cat] = catId;
            const section = document.createElement('div');
            section.className = 'drive-category-group';
            section.id = catId;
            section.innerHTML = `<h2 class="drive-category-title">${cat}</h2>`;
            grouped[cat].forEach(item => {
                const card = document.createElement('div');
                card.className = 'qa-card rebuttal-card';
                const actions = createActionButtons(item.id, 'rebuttal');
                card.innerHTML = `
                    <div class="qa-question rebuttal-objection"><span class="qa-badge rebuttal-badge-obj">質問</span><span>${item.question}</span></div>
                    <div class="qa-answer rebuttal-response"><span class="qa-badge rebuttal-badge-res">切返し</span><span>${item.answer}</span></div>
                `;
                card.querySelector('.qa-question').appendChild(actions);
                section.appendChild(card);
            });
            container.appendChild(section);
        });
        renderNav(categories, catMap);
    }

    function renderDriveList(items, container) {
        const tree = {};
        const largeCategories = new Set();
        const catFirstId = {};

        items.forEach(item => {
            const large = item.large || 'その他';
            let nameToDisplay = '';
            
            if (!tree[large]) tree[large] = { _files_: [], mediums: {} };
            largeCategories.add(large);

            if (item.detail && item.detail.trim() !== "") {
                const medium = item.medium || '未分類';
                const small = item.small || '未分類';
                nameToDisplay = item.detail;
                if (!tree[large].mediums[medium]) tree[large].mediums[medium] = { _files_: [], smalls: {} };
                if (!tree[large].mediums[medium].smalls[small]) tree[large].mediums[medium].smalls[small] = [];
                tree[large].mediums[medium].smalls[small].push({ ...item, displayName: nameToDisplay });
            } else if (item.small && item.small.trim() !== "") {
                const medium = item.medium || '未分類';
                nameToDisplay = item.small;
                if (!tree[large].mediums[medium]) tree[large].mediums[medium] = { _files_: [], smalls: {} };
                tree[large].mediums[medium]._files_.push({ ...item, displayName: nameToDisplay });
            } else if (item.medium && item.medium.trim() !== "") {
                nameToDisplay = item.medium;
                tree[large]._files_.push({ ...item, displayName: nameToDisplay });
            } else {
                nameToDisplay = large;
                tree[large]._files_.push({ ...item, displayName: nameToDisplay });
            }
        });

        let idx = 0;
        largeCategories.forEach(large => {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'drive-category-group';
            const catId = `drive-cat-${idx++}`;
            groupDiv.id = catId;
            catFirstId[large] = catId;

            const title = document.createElement('h2');
            title.className = 'drive-category-title';
            title.textContent = large;
            groupDiv.appendChild(title);

            const largeData = tree[large];

            if (largeData._files_.length > 0) {
                const ul = createFileList(largeData._files_);
                ul.classList.add('direct-list');
                groupDiv.appendChild(ul);
            }

            Object.keys(largeData.mediums).forEach(med => {
                const medData = largeData.mediums[med];
                const medBlock = document.createElement('div');
                medBlock.className = 'drive-medium-block';
                
                medBlock.innerHTML = `<div class="drive-medium-header"><svg class="folder-icon" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg><span>${med}</span></div>`;

                if (medData._files_.length > 0) {
                    const ul = createFileList(medData._files_);
                    ul.classList.add('direct-list');
                    medBlock.appendChild(ul);
                }

                Object.keys(medData.smalls).forEach(small => {
                    const files = medData.smalls[small];
                    if (files.length > 0) {
                        const smallGroup = document.createElement('div');
                        smallGroup.className = 'drive-small-group';
                        const smallHeader = document.createElement('div');
                        smallHeader.className = 'drive-small-header';
                        smallHeader.innerHTML = `<svg class="small-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/></svg>${small}`;
                        smallGroup.appendChild(smallHeader);
                        smallGroup.appendChild(createFileList(files));
                        medBlock.appendChild(smallGroup);
                    }
                });

                groupDiv.appendChild(medBlock);
            });
            container.appendChild(groupDiv);
        });
        renderNav(largeCategories, catFirstId);
    }

    function createFileList(files) {
        const ul = document.createElement('ul');
        ul.className = 'drive-file-list';
        files.forEach(file => {
            const li = document.createElement('a');
            li.href = file.url;
            li.target = "_blank";
            li.rel = "noopener noreferrer";
            li.className = 'drive-file-item';
            
            const wrapper = document.createElement('div');
            wrapper.className = 'file-content-wrapper';

            const type = getFileType(file.url);
            const thumbDiv = document.createElement('div');
            thumbDiv.className = 'file-thumbnail';
            if (type === 'youtube') {
                const ytId = extractYoutubeId(file.url);
                const img = document.createElement('img');
                img.src = `https://img.youtube.com/vi/${ytId}/mqdefault.jpg`;
                img.onerror = () => { thumbDiv.innerHTML = getFileIconSvg('web'); };
                thumbDiv.appendChild(img);
            } else {
                thumbDiv.innerHTML = getFileIconSvg(type);
            }
            wrapper.appendChild(thumbDiv);

            const info = document.createElement('div');
            info.className = 'file-info';
            const mainText = file.displayName;
            const subText = file.desc;
            info.innerHTML = `<div class="file-name">${mainText}</div>`;
            if(subText) info.innerHTML += `<div class="file-desc">${subText}</div>`;
            
            wrapper.appendChild(info);
            li.appendChild(wrapper);

            const actions = createActionButtons(file.id, 'drive');
            actions.onclick = (e) => { e.preventDefault(); e.stopPropagation(); };
            li.appendChild(actions);
            ul.appendChild(li);
        });
        return ul;
    }

    function createActionButtons(id, tab) {
        const div = document.createElement('div');
        div.className = 'action-buttons';
        const isStarred = state.starredItems.has(id);
        const isWatched = state.watchedItems.has(id);
        const starTitle = isStarred ? 'スター付きを外す' : 'スター付きにする';
        const checkLabel = tab === 'video' ? '試聴済み' : '確認済み';
        const checkTitle = isWatched ? `${checkLabel}を外す` : `${checkLabel}にする`;
        div.innerHTML = `
            <button class="icon-btn star-btn ${isStarred?'active':''}" onclick="toggleStar('${id}')" title="${starTitle}">
                <svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
            </button>
            <button class="icon-btn check-btn ${isWatched?'active':''}" onclick="toggleWatched('${id}')" title="${checkTitle}">
                <svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
            </button>
        `;
        return div;
    }

    function renderNav(categories, idMap) {
        const frag = document.createDocumentFragment();
        categories.forEach(cat => {
            const li = document.createElement('li');
            li.className = 'category-nav-item';
            li.textContent = cat;
            li.onclick = () => {
                const el = document.getElementById(idMap[cat]);
                if(el) el.scrollIntoView({behavior:'smooth', block:'start'});
            };
            frag.appendChild(li);
        });
        els.categoryNav.appendChild(frag);
    }

    /* --- Chatbot Functions --- */
    function toggleChat() {
        els.chatWindow.classList.toggle('active');
        if (els.chatWindow.classList.contains('active')) {
            els.chatInput.focus();
            scrollToBottom();
        }
    }

    function handleChatKey(e) { if (e.key === 'Enter') sendChatMessage(); }
    function scrollToBottom() { els.chatMessages.scrollTop = els.chatMessages.scrollHeight; }

    function navigateToItem(tab, index) {
        // Close chat
        els.chatWindow.classList.remove('active');
        // Switch to tab
        switchTab(tab);
        // Wait for render then scroll to the item
        requestAnimationFrame(() => {
            requestAnimationFrame(() => {
                let targetEl = null;
                if (tab === 'video') {
                    targetEl = document.getElementById(`video-${index}`);
                } else if (tab === 'drive') {
                    // For drive, find the file by index in current rendered items
                    const allFileItems = document.querySelectorAll('#list-drive .drive-file-item');
                    if (allFileItems[index]) targetEl = allFileItems[index];
                } else if (tab === 'qa') {
                    const allQaCards = document.querySelectorAll('#list-qa .qa-card');
                    if (allQaCards[index]) targetEl = allQaCards[index];
                } else if (tab === 'rebuttal') {
                    const allRebuttalCards = document.querySelectorAll('#list-rebuttal .qa-card');
                    if (allRebuttalCards[index]) targetEl = allRebuttalCards[index];
                }
                if (targetEl) {
                    targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // Highlight briefly
                    targetEl.style.transition = 'box-shadow 0.3s, outline 0.3s';
                    targetEl.style.outline = '2px solid var(--accent-color)';
                    targetEl.style.boxShadow = '0 0 0 4px rgba(35,131,226,0.15)';
                    setTimeout(() => {
                        targetEl.style.outline = 'none';
                        targetEl.style.boxShadow = '';
                    }, 2500);
                }
            });
        });
    }

    function formatChatMessage(text) {
        if (!text) return "";
        let formatted = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        formatted = formatted.replace(/\[([^\]]+)\]\((https?:\/\/[^\s\)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
        formatted = formatted.replace(/(?<!href="|">)(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer">リンク</a>');
        formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<b class="font-bold">$1</b>');
        formatted = formatted.replace(/\n/g, '<br>');
        return formatted;
    }

    function addMessage(text, type, appendHtml = "") {
        const div = document.createElement('div');
        div.className = `chat-msg ${type}`;
        div.innerHTML = formatChatMessage(text) + appendHtml;
        els.chatMessages.appendChild(div);
        scrollToBottom();
    }

    function addTypingIndicator() {
        const div = document.createElement('div');
        div.className = 'chat-msg bot typing-indicator';
        div.innerHTML = `<div class="typing-dots"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`;
        els.chatMessages.appendChild(div);
        scrollToBottom();
        return div;
    }

    function setInputLock(locked) {
        els.chatInput.disabled = locked;
        els.chatSendBtn.disabled = locked;
        els.chatInput.placeholder = locked ? "送信制限中です (3分間)" : "質問を入力...";
    }

    function calculateSimilarity(str1, str2) {
        if (!str1 || !str2) return 0.0;
        const s1 = str1.toLowerCase().replace(/\s+/g, "");
        const s2 = str2.toLowerCase().replace(/\s+/g, "");
        if (s1 === s2) return 1.0;
        if (s1.length < 2 || s2.length < 2) return 0.0;
        const getBigrams = (str) => {
            const bigrams = [];
            for (let i = 0; i < str.length - 1; i++) { bigrams.push(str.substring(i, i + 2)); }
            return bigrams;
        };
        const bg1 = getBigrams(s1);
        const bg2 = getBigrams(s2);
        let intersection = 0;
        const bg2Copy = [...bg2];
        for (const pair of bg1) {
            const idx = bg2Copy.indexOf(pair);
            if (idx !== -1) { intersection++; bg2Copy.splice(idx, 1); }
        }
        return (2.0 * intersection) / (bg1.length + bg2.length);
    }

    function findRelevantContents(query, maxResults = 5) {
        const taggedItems = [
            ...state.data.video.map((item, i) => ({ ...item, _tab: 'video', _index: i })),
            ...state.data.drive.map((item, i) => ({ ...item, _tab: 'drive', _index: i })),
            ...state.data.qa.map((item, i) => ({ ...item, _tab: 'qa', _index: i })),
            ...state.data.rebuttal.map((item, i) => ({ ...item, _tab: 'rebuttal', _index: i }))
        ];

        const scored = taggedItems.map(item => {
            let targetText = '';
            let displayText = '';
            let refLabel = '';

            if (item.sourceType === 'manual') {
                targetText = `${item.category} ${item.title} ${item.desc || ''}`;
                displayText = `[動画: ${item.title}] 内容: ${item.desc}`;
                refLabel = item.title;
            } else if (item.sourceType === 'material') {
                targetText = `${item.large} ${item.medium} ${item.small} ${item.detail} ${item.desc}`;
                const name = item.detail || item.small || item.medium || item.large;
                displayText = `[資料: ${name}] 内容: ${item.desc}`;
                refLabel = name;
            } else {
                targetText = `${item.category} ${item.question} ${item.answer}`;
                const tabLabel = item._tab === 'rebuttal' ? '切り返し' : 'Q&A';
                displayText = `[${tabLabel}] Q: ${item.question}\nA: ${item.answer}`;
                refLabel = item.question;
            }

            // keyword-based boost: split query into words and check if they appear in target
            const queryWords = query.toLowerCase().replace(/[\s　]+/g, ' ').split(' ').filter(w => w.length > 1);
            let keywordScore = 0;
            queryWords.forEach(w => {
                if (targetText.toLowerCase().includes(w)) keywordScore += 0.15;
            });

            const bigramScore = calculateSimilarity(query, targetText);
            const score = Math.min(bigramScore + keywordScore, 1.0);

            return { item, score, displayText, refLabel, tab: item._tab, index: item._index };
        });

        return scored
            .filter(s => s.score >= THRESHOLDS.SUGGESTION)
            .sort((a, b) => b.score - a.score)
            .slice(0, maxResults);
    }

    // Legacy wrapper for backward compatibility
    function findBestContextWithFuzzyLogic(query) {
        const results = findRelevantContents(query, 1);
        return results.length > 0 ? results[0] : null;
    }

    async function sendChatMessage() {
        const now = Date.now();
        if (state.lockedUntil > now) return;

        const text = els.chatInput.value.trim();
        if (!text) return;
        
        // Spam prevention
        const LIMIT_COUNT = 8;
        const LIMIT_WINDOW = 3 * 60 * 1000;
        state.messageTimestamps = state.messageTimestamps.filter(t => t > now - LIMIT_WINDOW);
        
        if (state.messageTimestamps.length >= LIMIT_COUNT) {
            state.lockedUntil = now + LIMIT_WINDOW;
            const lockMsg = '連続で質問をしすぎているようです。しばらく経ってから再度お試しください。<br>または、<a href="https://lin.ee/0rNANZ7" target="_blank" rel="noopener noreferrer">事務局へ連絡</a>';
            addMessage(lockMsg, 'system');
            els.chatInput.value = '';
            setInputLock(true);
            setTimeout(() => { if (Date.now() >= state.lockedUntil) { setInputLock(false); state.lockedUntil = 0; } }, LIMIT_WINDOW);
            return;
        }

        if (!CONFIG.geminiApiKey) { alert("APIキーが設定されていません。"); return; }
        state.messageTimestamps.push(now);
        addMessage(text, 'user');
        els.chatInput.value = '';
        const loadingDiv = addTypingIndicator();

        try {
            const relevantResults = findRelevantContents(text, 5);
            const topScore = relevantResults.length > 0 ? relevantResults[0].score : 0;
            let prompt = '';
            const commonInstruction = `\n[AIの振る舞い・回答ルール]\n1. 機能に関する質問: 「パートナーQA、商談切り返し、動画・資料マニュアルの案内が可能です」と回答。\n2. 挨拶: 端的に返す。\n3. 不適切: 拒否する。\n4. フォーマット: **太字**使用。外部URLリンクは[こちら](URL)形式。\n5. 関連する参考情報がある場合は、回答内で「こちらの動画」「こちらのQ&A」「こちらの資料」「こちらの切り返し集」などの言葉で言及してください。具体的なリンクボタンは回答の後にシステムが自動で付与するため、回答文内にREF_LINKタグは書かないでください。`;

            // Build context text from relevant results
            const contextText = relevantResults.map((r, i) => {
                const tabLabelMap = { video: '動画マニュアル', drive: '資料ドライブ', qa: 'Q&A', rebuttal: '切り返し集' };
                return `${i+1}. [${tabLabelMap[r.tab]}] ${r.displayText}`;
            }).join('\n');

            if (topScore >= THRESHOLDS.CONFIDENCE) {
                prompt = `あなたは営業パートナー支援AIです。以下の[参考情報]を元に質問に回答してください。複数の参考情報がある場合は、関連するものすべてに言及してください。\n\n[参考情報]\n${contextText}\n\n[ユーザーの質問]\n${text}\n${commonInstruction}`;
            } else if (topScore >= THRESHOLDS.SUGGESTION) {
                prompt = `あなたは営業パートナー支援AIです。完全一致しませんでしたが、近い資料が見つかりました。「もしかしてこちらですか？」と提案してください。\n\n[近い資料]\n${contextText}\n\n[ユーザーの質問]\n${text}\n${commonInstruction}`;
            } else {
                prompt = `あなたは営業パートナー支援AIです。関連資料は見当たりませんでしたが、ルールに従って回答してください。業務的な質問で答えられない場合は謝罪してください。\n\n[ユーザーの質問]\n${text}\n${commonInstruction}`;
            }

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${CONFIG.geminiApiKey}`;
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });

            const data = await response.json();
            loadingDiv.remove();

            if (data.error) {
                addMessage(`システムエラー: ${data.error.message}`, 'system');
            } else {
                let answer = data.candidates?.[0]?.content?.parts?.[0]?.text || 'すみません、回答を生成できませんでした。';
                
                // Build reference link buttons from relevant results
                let refLinksHtml = '';
                if (relevantResults.length > 0 && topScore >= THRESHOLDS.SUGGESTION) {
                    const tabLabelMap = { video: '動画マニュアル', drive: '資料ドライブ', qa: 'Q&A', rebuttal: '切り返し集' };
                    const badgeClassMap = { video: 'badge-video', drive: 'badge-drive', qa: 'badge-qa', rebuttal: 'badge-rebuttal' };
                    const iconMap = {
                        video: '<svg class="ref-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>',
                        drive: '<svg class="ref-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>',
                        qa: '<svg class="ref-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
                        rebuttal: '<svg class="ref-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>'
                    };
                    refLinksHtml = '<div class="chat-ref-links">';
                    // For drive items with external URLs, also provide external link
                    relevantResults.forEach(r => {
                        const label = r.refLabel.length > 30 ? r.refLabel.substring(0, 30) + '…' : r.refLabel;
                        const badge = `<span class="ref-badge ${badgeClassMap[r.tab]}">${tabLabelMap[r.tab]}</span>`;
                        const icon = iconMap[r.tab];
                        if (r.tab === 'drive' && r.item.url && r.item.url !== '#') {
                            // Drive: also offer external link
                            refLinksHtml += `<a class="chat-ref-btn" href="${r.item.url}" target="_blank" rel="noopener noreferrer">${icon}${badge}<span>${label}</span></a>`;
                        } else {
                            refLinksHtml += `<a class="chat-ref-btn" onclick="navigateToItem('${r.tab}', ${r.index})">${icon}${badge}<span>${label}</span></a>`;
                        }
                    });
                    refLinksHtml += '</div>';
                }

                const disclaimer = '<div style="display:block; margin-top:10px; padding-top:8px; border-top:1px solid rgba(0,0,0,0.1); font-size:11px; color:#888; line-height:1.4;">※回答は必ずしも正しいとは限りません。重要な情報は事務局まで確認するようにしてください。</div>';
                addMessage(answer, 'bot', refLinksHtml + disclaimer);
            }
        } catch (err) {
            loadingDiv.remove();
            console.error(err);
            addMessage("通信エラーが発生しました。", 'system');
        }
    }

    function init() {
        loadUserPreferences();
        els.input.addEventListener('input', (e) => { state.searchText = e.target.value; renderView(); });
        window.addEventListener('resize', updateLayoutMetrics);
        fetchAllData();
        setInterval(fetchAllData, CONFIG.refreshInterval);
    }

    document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>