<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>成約申請フォーム｜BakuApo パートナーポータル</title>
    <meta name="robots" content="noindex, nofollow">
    <link rel="icon" href="/favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+JP:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root{--bg:#FAFAFA;--bg-card:#FFF;--bg-alt:#F3F4F6;--border:#E5E7EB;--border-hover:#D1D5DB;--text-primary:#111827;--text-secondary:#6B7280;--text-muted:#9CA3AF;--accent:#0852FF;--accent-light:rgba(8,82,255,.08);--accent-subtle:rgba(8,82,255,.04);--success:#10B981;--warning:#F59E0B;--danger:#EF4444}
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:'Inter','Noto Sans JP',-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:var(--bg);color:var(--text-primary);line-height:1.7;font-size:16px;-webkit-font-smoothing:antialiased}
        .site-header{position:sticky;top:0;z-index:100;background:rgba(255,255,255,.85);backdrop-filter:saturate(180%) blur(20px);-webkit-backdrop-filter:saturate(180%) blur(20px);border-bottom:1px solid var(--border)}
        .header-inner{max-width:1000px;margin:0 auto;padding:14px 24px;display:flex;align-items:center;justify-content:space-between}
        .header-logo img{height:58px}
        .header-label{font-size:13px;font-weight:600;color:var(--text-secondary)}
        .main{max-width:680px;margin:0 auto;padding:48px 24px 100px}

        /* Page Title */
        .page-top{margin-bottom:40px}
        .page-top .back-link{display:inline-flex;align-items:center;gap:6px;font-size:13px;color:var(--text-muted);text-decoration:none;margin-bottom:20px;transition:color .15s}
        .page-top .back-link:hover{color:var(--accent)}
        .page-top .back-link svg{width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:2}
        .page-top h1{font-size:32px;font-weight:800;letter-spacing:-.03em;margin-bottom:8px}
        .page-top p{font-size:16px;color:var(--text-secondary)}

        /* Progress */
        .progress-bar{display:flex;gap:6px;margin-bottom:40px}
        .progress-step{flex:1;height:4px;border-radius:2px;background:var(--border);transition:background .3s}
        .progress-step.active{background:var(--accent)}
        .progress-step.done{background:var(--success)}

        /* Form Section */
        .form-section{background:var(--bg-card);border:1px solid var(--border);border-radius:16px;padding:32px;margin-bottom:20px;transition:box-shadow .2s}
        .form-section:hover{box-shadow:0 2px 16px rgba(0,0,0,.03)}
        .form-section-label{font-size:11px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--accent);background:var(--accent-light);display:inline-block;padding:4px 12px;border-radius:6px;margin-bottom:14px}
        .form-section h2{font-size:24px;font-weight:700;margin-bottom:20px;letter-spacing:-.01em}

        /* Form Elements */
        .form-group{margin-bottom:24px}
        .form-group:last-child{margin-bottom:0}
        .form-label{display:block;font-size:16.5px;font-weight:600;margin-bottom:8px}
        .form-label .required{color:var(--danger);font-size:13px;margin-left:4px}
        .form-input{width:100%;padding:12px 16px;border:1px solid var(--border);border-radius:10px;font-size:16px;font-family:inherit;color:var(--text-primary);background:var(--bg-card);transition:border-color .2s,box-shadow .2s;-webkit-appearance:none}
        .form-input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-light)}
        .form-input:disabled{background:var(--bg-alt);color:var(--text-muted);cursor:not-allowed}
        .form-hint{font-size:14px;color:var(--text-muted);margin-top:6px;line-height:1.6}
        textarea.form-input{resize:vertical;min-height:80px}

        /* Checkbox & Radio */
        .check-group{display:flex;flex-direction:column;gap:12px}
        .check-item{display:flex;align-items:flex-start;gap:12px;cursor:pointer;padding:14px 16px;border:1px solid var(--border);border-radius:10px;transition:all .15s;user-select:none}
        .check-item:hover{border-color:var(--border-hover);background:var(--bg-alt)}
        .check-item.checked{border-color:var(--accent);background:var(--accent-subtle)}
        .check-item input[type="checkbox"],.check-item input[type="radio"]{appearance:none;-webkit-appearance:none;width:20px;height:20px;border:2px solid var(--border);border-radius:6px;flex-shrink:0;margin-top:1px;position:relative;cursor:pointer;transition:all .15s}
        .check-item input[type="radio"]{border-radius:50%}
        .check-item input:checked{background:var(--accent);border-color:var(--accent)}
        .check-item input[type="checkbox"]:checked::after{content:'';position:absolute;left:5px;top:2px;width:6px;height:10px;border:solid #fff;border-width:0 2px 2px 0;transform:rotate(45deg)}
        .check-item input[type="radio"]:checked::after{content:'';position:absolute;left:4px;top:4px;width:8px;height:8px;border-radius:50%;background:#fff}
        .check-item-text{font-size:16px;font-weight:500;line-height:1.6}
        .check-item-text small{display:block;font-size:14px;color:var(--text-muted);font-weight:400;margin-top:2px}

        /* Product Card */
        .product-card{background:var(--bg-alt);border:1px solid var(--border);border-radius:12px;padding:20px 24px;display:flex;align-items:center;gap:16px}
        .product-card .product-check{width:22px;height:22px;border-radius:6px;background:var(--accent);display:flex;align-items:center;justify-content:center;flex-shrink:0}
        .product-card .product-check svg{width:14px;height:14px;stroke:#fff;fill:none;stroke-width:3}
        .product-card .product-info h3{font-size:18px;font-weight:700;margin-bottom:2px}
        .product-card .product-info p{font-size:16px;color:var(--text-secondary)}

        /* Supplement Links */
        .supplement{display:flex;gap:16px;flex-wrap:wrap;margin-top:16px}
        .supplement a{font-size:14px;color:var(--text-muted);text-decoration:none;border-bottom:1px dashed var(--border);padding-bottom:1px;transition:color .15s}
        .supplement a:hover{color:var(--accent);border-color:var(--accent)}

        /* Commission Display */
        .commission-box{background:linear-gradient(135deg,#f0f4ff 0%,#fafafa 100%);border:2px solid var(--accent);border-radius:14px;padding:28px;text-align:center}
        .commission-amount{font-size:32px;font-weight:800;color:var(--accent);letter-spacing:-.02em;margin-bottom:4px}
        .commission-detail{font-size:16px;color:var(--text-secondary)}

        /* Bank Form */
        .bank-form{display:none;margin-top:20px;padding:24px;background:var(--bg-alt);border-radius:12px}
        .bank-form.visible{display:block}
        .bank-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        .bank-saved{display:none;margin-top:20px;padding:20px 24px;background:var(--bg-alt);border-radius:12px;position:relative}
        .bank-saved.visible{display:block}
        .bank-saved-title{font-size:12px;font-weight:600;color:var(--text-muted);margin-bottom:10px}
        .bank-saved-info{font-size:15px;line-height:1.8}
        .bank-saved-edit{position:absolute;top:16px;right:16px;font-size:12px;color:var(--accent);background:none;border:1px solid var(--accent);padding:4px 12px;border-radius:6px;cursor:pointer;font-family:inherit;font-weight:600;transition:all .15s}
        .bank-saved-edit:hover{background:var(--accent);color:#fff}

        /* Autocomplete */
        .autocomplete-wrap{position:relative}
        .autocomplete-list{position:absolute;top:100%;left:0;right:0;z-index:50;background:var(--bg-card);border:1px solid var(--border);border-radius:10px;margin-top:4px;max-height:200px;overflow-y:auto;display:none;box-shadow:0 8px 24px rgba(0,0,0,.08)}
        .autocomplete-list.open{display:block}
        .autocomplete-item{padding:10px 16px;font-size:15px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;transition:background .1s}
        .autocomplete-item:hover,.autocomplete-item.highlighted{background:var(--accent-light);color:var(--accent)}
        .autocomplete-item .ac-code{font-size:12px;color:var(--text-muted);font-family:'SF Mono','Fira Code',monospace}
        .autocomplete-item:hover .ac-code{color:var(--accent)}

        /* Save Button */
        .btn-save{display:inline-flex;align-items:center;gap:8px;font-size:14px;font-weight:600;font-family:inherit;color:#fff;background:var(--accent);padding:10px 24px;border-radius:10px;border:none;cursor:pointer;transition:all .2s;margin-top:8px}
        .btn-save:hover{background:#063FCC}

        /* Confirmation */
        .confirm-box{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;overflow:hidden}
        .confirm-row{display:flex;justify-content:space-between;align-items:flex-start;padding:16px 20px;border-bottom:1px solid var(--border);font-size:15px}
        .confirm-row:last-child{border-bottom:none}
        .confirm-row dt{color:var(--text-secondary);font-weight:500;flex-shrink:0}
        .confirm-row dd{font-weight:600;text-align:right}
        .confirm-row dd.amount{color:var(--accent);font-size:18px;font-weight:800}
        .confirm-note{font-size:14px;color:var(--text-muted);margin-top:12px;line-height:1.7}

        /* Submit */
        .submit-section{text-align:center;padding-top:8px}
        .btn-submit{display:inline-flex;align-items:center;gap:10px;font-size:16px;font-weight:700;font-family:inherit;color:#fff;background:var(--accent);padding:18px 48px;border-radius:14px;border:none;cursor:pointer;transition:all .2s;box-shadow:0 4px 20px rgba(8,82,255,.2);margin-top:20px}
        .btn-submit:hover{background:#063FCC;transform:translateY(-2px);box-shadow:0 8px 28px rgba(8,82,255,.3)}
        .btn-submit:disabled{background:var(--text-muted);cursor:not-allowed;transform:none;box-shadow:none}
        .btn-submit svg{width:18px;height:18px}

        /* Error */
        .form-error{color:var(--danger);font-size:13px;margin-top:6px;display:none}
        .form-error.visible{display:block}

        .site-footer{text-align:center;padding:32px 24px;border-top:1px solid var(--border)}
        .site-footer p{font-size:12px;color:var(--text-muted)}

        @media(max-width:640px){
            .main{padding:32px 16px 80px}
            .form-section{padding:24px 20px}
            .bank-row{grid-template-columns:1fr}
            .commission-amount{font-size:26px}
            .confirm-row{flex-direction:column;gap:4px}
            .confirm-row dd{text-align:left}
        }

        /* Congrats Modal */
        .congrats-overlay{position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.35);backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);opacity:0;transition:opacity .4s;pointer-events:none}
        .congrats-overlay.show{opacity:1;pointer-events:auto}
        .congrats-overlay.hide{opacity:0;pointer-events:none}
        .congrats-modal{background:#fff;border-radius:24px;padding:48px 40px 24px;text-align:center;max-width:420px;width:90%;position:relative;transform:scale(.85) translateY(20px);transition:transform .45s cubic-bezier(.34,1.56,.64,1),opacity .4s;opacity:0;box-shadow:0 24px 64px rgba(0,0,0,.15)}
        .congrats-overlay.show .congrats-modal{transform:scale(1) translateY(0);opacity:1}
        .congrats-close{position:absolute;top:14px;right:14px;width:32px;height:32px;border-radius:8px;border:1px solid var(--border);background:var(--bg-alt);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px;color:var(--text-muted);transition:all .15s;line-height:1}
        .congrats-close:hover{background:var(--border);color:var(--text-primary)}
        .congrats-emoji{margin-bottom:16px;display:block;animation:congratsBounce .6s ease}
        .congrats-emoji img{width:192px;height:auto;}
        @keyframes congratsBounce{0%{transform:scale(0) rotate(-20deg)}50%{transform:scale(1.2) rotate(5deg)}100%{transform:scale(1) rotate(0)}}
        .congrats-modal h2{font-size:24px;font-weight:800;letter-spacing:-.02em;margin-bottom:8px;color:var(--text-primary)}
        .congrats-modal p{font-size:15px;color:var(--text-secondary);line-height:1.7;margin-bottom:24px}
        .congrats-progress{width:100%;height:4px;background:var(--bg-alt);border-radius:4px;overflow:hidden}
        .congrats-progress-bar{height:100%;background:linear-gradient(90deg,var(--accent),#635BFF);border-radius:4px;width:0%;transition:width .05s linear}
        .confetti-canvas{position:fixed;inset:0;z-index:9998;pointer-events:none}
    </style>
</head>
<body>
    <!-- Confetti -->
    <canvas class="confetti-canvas" id="confettiCanvas"></canvas>

    <!-- Congrats Modal -->
    <div class="congrats-overlay" id="congratsOverlay">
        <div class="congrats-modal">
            <button class="congrats-close" id="congratsClose">&times;</button>
            <span class="congrats-emoji"><img src="/man-woman-01.svg" alt="おめでとう"></span>
            <h2>ご成約おめでとうございます！</h2>
            <p>大切なお客様をお繋ぎいただき、<br>誠にありがとうございます。</p>
            <p>今後も一緒に、BakuApoの価値を<br>広げていけましたら幸いです。</p>
            <div class="congrats-progress"><div class="congrats-progress-bar" id="congratsBar"></div></div>
        </div>
    </div>

    <header class="site-header">
        <div class="header-inner">
            <div class="header-logo"><img src="/bakuapo-logo-useer.svg" alt="BakuApo"></div>
            <span class="header-label">パートナー様専用｜成約申請</span>
        </div>
    </header>

    <main class="main">
        <div class="page-top">
            <a href="/conversion-report/" class="back-link">
                <svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>
                成約申請トップに戻る
            </a>
            <h1>成約申請フォーム</h1>
            <p>必要事項をご入力の上、送信してください。</p>
        </div>

        <div class="progress-bar">
            <div class="progress-step active" id="prog1"></div>
            <div class="progress-step" id="prog2"></div>
            <div class="progress-step" id="prog3"></div>
            <div class="progress-step" id="prog4"></div>
        </div>

        <form id="appForm" novalidate>
            <!-- Section 1: パートナー様情報 -->
            <div class="form-section">
                <span class="form-section-label">Step 1</span>
                <h2>申請者情報</h2>
                <div class="form-group">
                    <label class="form-label">パートナー様（正規代理店）名<span class="required">*</span></label>
                    <input type="text" class="form-input" id="partnerName" placeholder="例：山田 太郎" required>
                </div>
                <div class="form-group">
                    <label class="form-label">お客様の氏名<span class="required">*</span></label>
                    <input type="text" class="form-input" id="customerName" placeholder="例：佐藤 花子" required>
                </div>
            </div>

            <!-- Section 2: 成約商品 -->
            <div class="form-section">
                <span class="form-section-label">Step 2</span>
                <h2>成約した商品</h2>
                <div class="product-card">
                    <div class="product-check">
                        <svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>
                    </div>
                    <div class="product-info">
                        <h3>BakuApo（バクアポ）</h3>
                        <p>税込 ¥550,000</p>
                    </div>
                </div>
                <p class="form-hint">※ 現在、お取り扱い商品は上記1件のみです。</p>
            </div>

            <!-- Section 3: 申請条件 -->
            <div class="form-section">
                <span class="form-section-label">Step 3</span>
                <h2>申請条件の確認</h2>
                <p style="font-size:16px;color:var(--text-secondary);margin-bottom:16px">以下の2つの条件をご確認ください。両方にチェックが入っていないと申請できません。</p>
                <div class="check-group">
                    <label class="check-item" id="cond1Wrap">
                        <input type="checkbox" id="cond1">
                        <span class="check-item-text">お客様は、既に「契約フォーム」の記入が完了しています</span>
                    </label>
                    <label class="check-item" id="cond2Wrap">
                        <input type="checkbox" id="cond2">
                        <span class="check-item-text">お客様は、既に決済が完了しています</span>
                    </label>
                </div>
                <div class="supplement">
                    <a href="https://partner.bakuapo.com/contract" target="_blank">「契約フォーム」はこちら →</a>
                    <a href="https://partner.bakuapo.com/checkout" target="_blank">「決済フォーム」はこちら →</a>
                </div>
                <p class="form-error" id="condError">両方のチェックが必要です。</p>
            </div>

            <!-- Section 4: 報酬額 -->
            <div class="form-section">
                <span class="form-section-label">Step 4</span>
                <h2>報酬額</h2>
                <p style="font-size:16px;color:var(--text-secondary);margin-bottom:20px">本申請で確定する報酬額は以下の通りです。</p>
                <div class="commission-box">
                    <div class="commission-amount">¥275,000<span style="font-size:14px;font-weight:600;color:var(--text-secondary)">（税込）</span></div>
                    <p class="commission-detail">販売額 ¥550,000（税込）× 50% = ¥275,000（税込）</p>
                </div>
            </div>

            <!-- Section 5: 報酬お振込先 -->
            <div class="form-section">
                <span class="form-section-label">Step 5</span>
                <h2>報酬お振込先</h2>
                <div class="check-group">
                    <label class="check-item" id="bankExistWrap">
                        <input type="radio" name="bankStatus" value="existing" id="bankExisting" checked>
                        <span class="check-item-text">既にお振込先が指定済み<small>以前の申請で登録済みの方はこちら</small></span>
                    </label>
                    <label class="check-item" id="bankNewWrap">
                        <input type="radio" name="bankStatus" value="new" id="bankNew">
                        <span class="check-item-text">お振込先未指定（初回申請）<small>初めて成約申請される方はこちら</small></span>
                    </label>
                </div>

                <!-- Bank Saved Display -->
                <div class="bank-saved" id="bankSaved">
                    <p class="bank-saved-title">登録済みの振込先情報</p>
                    <div class="bank-saved-info" id="bankSavedInfo"></div>
                    <button type="button" class="bank-saved-edit" id="bankEditBtn">編集</button>
                </div>

                <!-- Bank Registration Form -->
                <div class="bank-form" id="bankForm">
                    <h3 style="font-size:14px;font-weight:700;margin-bottom:16px">お振込先登録（初回のみ）</h3>
                    <div class="form-group">
                        <label class="form-label">銀行名<span class="required">*</span></label>
                        <div class="autocomplete-wrap">
                            <input type="text" class="form-input" id="bankName" placeholder="銀行名を入力（例：みずほ銀行）" autocomplete="off">
                            <div class="autocomplete-list" id="bankAcList"></div>
                        </div>
                        <input type="hidden" id="bankCode">
                    </div>
                    <div class="bank-row">
                        <div class="form-group">
                            <label class="form-label">支店名<span class="required">*</span></label>
                            <input type="text" class="form-input" id="branchName" placeholder="例：新宿支店">
                        </div>
                        <div class="form-group">
                            <label class="form-label">支店コード<span class="required">*</span></label>
                            <input type="text" class="form-input" id="branchCode" placeholder="3桁" maxlength="3" inputmode="numeric">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">口座種別<span class="required">*</span></label>
                        <div class="check-group" style="flex-direction:row;gap:12px">
                            <label class="check-item" style="flex:1">
                                <input type="radio" name="accountType" value="普通" id="typeNormal" checked>
                                <span class="check-item-text">普通</span>
                            </label>
                            <label class="check-item" style="flex:1">
                                <input type="radio" name="accountType" value="当座" id="typeCurrent">
                                <span class="check-item-text">当座</span>
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">口座番号<span class="required">*</span></label>
                        <input type="text" class="form-input" id="accountNumber" placeholder="7桁" maxlength="7" inputmode="numeric">
                    </div>
                    <div class="form-group">
                        <label class="form-label">口座名義（カナ）<span class="required">*</span></label>
                        <input type="text" class="form-input" id="accountHolder" placeholder="例：ヤマダ タロウ">
                    </div>
                    <p class="form-error" id="bankError">すべての項目をご入力ください。</p>
                    <button type="button" class="btn-save" id="bankSaveBtn">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                        保存する
                    </button>
                </div>
            </div>

            <!-- Section 6: 確認 -->
            <div class="form-section" style="border-color:var(--accent);border-width:2px">
                <span class="form-section-label">確認</span>
                <h2>申請内容の確認</h2>
                <div class="confirm-box">
                    <div class="confirm-row">
                        <dt>パートナー様名</dt>
                        <dd id="confirmPartner">—</dd>
                    </div>
                    <div class="confirm-row">
                        <dt>お客様の氏名</dt>
                        <dd id="confirmCustomer">—</dd>
                    </div>
                    <div class="confirm-row">
                        <dt>成約商品</dt>
                        <dd>BakuApo（バクアポ）</dd>
                    </div>
                    <div class="confirm-row">
                        <dt>報酬額</dt>
                        <dd class="amount" id="confirmAmount">¥275,000（税込）</dd>
                    </div>
                    <div class="confirm-row">
                        <dt>お振込先</dt>
                        <dd id="confirmBank">既に設定済み</dd>
                    </div>
                    <div class="confirm-row">
                        <dt>お振り込み予定日</dt>
                        <dd id="confirmPayDate">—</dd>
                    </div>
                </div>
                <div class="confirm-note">
                    ※ 他の報酬発生がある場合は、合算でお振り込みいたします。<br>
                    ※ お客様からの入金が確認できない場合はお振り込みが遅れる場合がございます。
                </div>

                <div style="margin-top:24px">
                    <label class="check-item" id="finalCheckWrap">
                        <input type="checkbox" id="finalCheck">
                        <span class="check-item-text">送信内容が正しいことを確認しました。</span>
                    </label>
                </div>

                <div class="submit-section">
                    <button type="submit" class="btn-submit" id="submitBtn" disabled>
                        <svg viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M8 5v14l11-7z"/></svg>
                        成約申請を送信する
                    </button>
                </div>
            </div>
        </form>
    </main>

    <footer class="site-footer">
        <p>&copy; 2026 BakuApo &amp; CHAINSODA Co., Ltd. — All rights reserved.</p>
    </footer>

    <script>
    // ===== Bank Data =====
    const BANKS = [
        {name:'みずほ銀行',code:'0001'},{name:'三菱UFJ銀行',code:'0005'},{name:'三井住友銀行',code:'0009'},
        {name:'りそな銀行',code:'0010'},{name:'埼玉りそな銀行',code:'0017'},
        {name:'PayPay銀行',code:'0033'},{name:'セブン銀行',code:'0034'},{name:'ソニー銀行',code:'0035'},
        {name:'楽天銀行',code:'0036'},{name:'住信SBIネット銀行',code:'0038'},{name:'auじぶん銀行',code:'0039'},
        {name:'イオン銀行',code:'0040'},{name:'みんなの銀行',code:'0043'},{name:'UI銀行',code:'0044'},
        {name:'北海道銀行',code:'0116'},{name:'青森銀行',code:'0117'},{name:'みちのく銀行',code:'0118'},
        {name:'秋田銀行',code:'0119'},{name:'北都銀行',code:'0120'},{name:'荘内銀行',code:'0121'},
        {name:'山形銀行',code:'0122'},{name:'岩手銀行',code:'0123'},{name:'東邦銀行',code:'0126'},
        {name:'群馬銀行',code:'0128'},{name:'足利銀行',code:'0129'},{name:'常陽銀行',code:'0130'},
        {name:'筑波銀行',code:'0131'},{name:'武蔵野銀行',code:'0133'},{name:'千葉銀行',code:'0134'},
        {name:'千葉興業銀行',code:'0135'},{name:'きらぼし銀行',code:'0137'},{name:'横浜銀行',code:'0138'},
        {name:'第四北越銀行',code:'0140'},{name:'山梨中央銀行',code:'0142'},{name:'八十二銀行',code:'0143'},
        {name:'北陸銀行',code:'0144'},{name:'富山銀行',code:'0145'},{name:'北國銀行',code:'0146'},
        {name:'福井銀行',code:'0147'},{name:'静岡銀行',code:'0149'},{name:'スルガ銀行',code:'0150'},
        {name:'清水銀行',code:'0151'},{name:'大垣共立銀行',code:'0152'},{name:'十六銀行',code:'0153'},
        {name:'三十三銀行',code:'0154'},{name:'百五銀行',code:'0155'},{name:'滋賀銀行',code:'0157'},
        {name:'京都銀行',code:'0158'},{name:'関西みらい銀行',code:'0159'},{name:'池田泉州銀行',code:'0161'},
        {name:'南都銀行',code:'0162'},{name:'紀陽銀行',code:'0163'},{name:'但馬銀行',code:'0164'},
        {name:'鳥取銀行',code:'0166'},{name:'山陰合同銀行',code:'0167'},{name:'中国銀行',code:'0168'},
        {name:'広島銀行',code:'0169'},{name:'山口銀行',code:'0170'},{name:'阿波銀行',code:'0172'},
        {name:'百十四銀行',code:'0173'},{name:'伊予銀行',code:'0174'},{name:'四国銀行',code:'0175'},
        {name:'福岡銀行',code:'0177'},{name:'筑邦銀行',code:'0178'},{name:'佐賀銀行',code:'0179'},
        {name:'十八親和銀行',code:'0180'},{name:'肥後銀行',code:'0182'},{name:'大分銀行',code:'0183'},
        {name:'宮崎銀行',code:'0184'},{name:'鹿児島銀行',code:'0185'},{name:'琉球銀行',code:'0187'},
        {name:'沖縄銀行',code:'0188'},{name:'西日本シティ銀行',code:'0190'},{name:'北九州銀行',code:'0191'},
        {name:'三菱UFJ信託銀行',code:'0288'},{name:'みずほ信託銀行',code:'0289'},
        {name:'三井住友信託銀行',code:'0294'},{name:'GMOあおぞらネット銀行',code:'0310'},
        {name:'SBI新生銀行',code:'0397'},{name:'あおぞら銀行',code:'0398'},
        {name:'東京スター銀行',code:'0526'},{name:'ゆうちょ銀行',code:'9900'}
    ];

    // Google Apps Script Web App URL
    const FORM_ENDPOINT = 'https://script.google.com/macros/s/AKfycbwb3W-2pfK_Ar4fBjoFcMQG7AIjkFn44kCzL5h6xjuRespoZTc25war2TVnZZ7Cgepk/exec';

    // ===== DOM =====
    const $ = id => document.getElementById(id);
    const partnerName = $('partnerName');
    const customerName = $('customerName');
    const cond1 = $('cond1'), cond2 = $('cond2');
    const bankExisting = $('bankExisting'), bankNew = $('bankNew');
    const bankFormEl = $('bankForm'), bankSavedEl = $('bankSaved');
    const bankNameInput = $('bankName'), bankCodeInput = $('bankCode');
    const branchName = $('branchName'), branchCode = $('branchCode');
    const accountNumber = $('accountNumber'), accountHolder = $('accountHolder');
    const finalCheck = $('finalCheck'), submitBtn = $('submitBtn');
    const acList = $('bankAcList');

    let bankInfoSaved = false;
    let savedBankData = null;
    let acHighlight = -1;

    // ===== Payment Date =====
    function getPaymentDate() {
        const today = new Date();
        const d = new Date(today.getFullYear(), today.getMonth() + 2, 0);
        return `${d.getFullYear()}年${d.getMonth()+1}月${d.getDate()}日`;
    }
    $('confirmPayDate').textContent = getPaymentDate();

    // ===== Checkbox UI =====
    document.querySelectorAll('.check-item input').forEach(inp => {
        inp.addEventListener('change', () => {
            const wrap = inp.closest('.check-item');
            if (inp.type === 'checkbox') {
                wrap.classList.toggle('checked', inp.checked);
            } else if (inp.type === 'radio') {
                document.querySelectorAll(`input[name="${inp.name}"]`).forEach(r => {
                    r.closest('.check-item').classList.toggle('checked', r.checked);
                });
            }
            updateState();
        });
        // Init
        if (inp.checked) inp.closest('.check-item').classList.add('checked');
    });

    // ===== Bank Status Toggle =====
    bankExisting.addEventListener('change', () => { bankFormEl.classList.remove('visible'); updateState(); });
    bankNew.addEventListener('change', () => {
        if (!bankInfoSaved) { bankFormEl.classList.add('visible'); bankSavedEl.classList.remove('visible'); }
        updateState();
    });

    // ===== Bank Autocomplete =====
    bankNameInput.addEventListener('input', () => {
        const val = bankNameInput.value.trim();
        if (!val) { acList.classList.remove('open'); return; }
        const filtered = BANKS.filter(b => b.name.includes(val) || b.code.includes(val));
        if (!filtered.length) { acList.classList.remove('open'); return; }
        acHighlight = -1;
        acList.innerHTML = filtered.map((b,i) =>
            `<div class="autocomplete-item" data-idx="${i}" data-name="${b.name}" data-code="${b.code}">
                <span>${b.name}</span><span class="ac-code">${b.code}</span>
            </div>`
        ).join('');
        acList.classList.add('open');
    });

    acList.addEventListener('click', e => {
        const item = e.target.closest('.autocomplete-item');
        if (!item) return;
        bankNameInput.value = item.dataset.name;
        bankCodeInput.value = item.dataset.code;
        acList.classList.remove('open');
    });

    bankNameInput.addEventListener('keydown', e => {
        const items = acList.querySelectorAll('.autocomplete-item');
        if (!items.length || !acList.classList.contains('open')) return;
        if (e.key === 'ArrowDown') { e.preventDefault(); acHighlight = Math.min(acHighlight+1, items.length-1); }
        else if (e.key === 'ArrowUp') { e.preventDefault(); acHighlight = Math.max(acHighlight-1, 0); }
        else if (e.key === 'Enter' && acHighlight >= 0) {
            e.preventDefault();
            items[acHighlight].click();
            return;
        } else return;
        items.forEach((it,i) => it.classList.toggle('highlighted', i === acHighlight));
        items[acHighlight]?.scrollIntoView({block:'nearest'});
    });

    document.addEventListener('click', e => {
        if (!e.target.closest('.autocomplete-wrap')) acList.classList.remove('open');
    });

    // ===== Bank Save =====
    $('bankSaveBtn').addEventListener('click', () => {
        const bn = bankNameInput.value.trim();
        const bc = bankCodeInput.value;
        const brn = branchName.value.trim();
        const brc = branchCode.value.trim();
        const acType = document.querySelector('input[name="accountType"]:checked').value;
        const acNum = accountNumber.value.trim();
        const acHold = accountHolder.value.trim();

        if (!bn || !brn || !brc || !acNum || !acHold) {
            $('bankError').classList.add('visible');
            return;
        }
        $('bankError').classList.remove('visible');

        savedBankData = { bankName: bn, bankCode: bc, branchName: brn, branchCode: brc, accountType: acType, accountNumber: acNum, accountHolder: acHold };
        bankInfoSaved = true;

        $('bankSavedInfo').innerHTML =
            `${bn}（${bc}）${brn}（${brc}）<br>${acType} ${acNum}<br>名義：${acHold}`;
        bankFormEl.classList.remove('visible');
        bankSavedEl.classList.add('visible');
        updateState();
    });

    $('bankEditBtn').addEventListener('click', () => {
        bankInfoSaved = false;
        bankSavedEl.classList.remove('visible');
        bankFormEl.classList.add('visible');
        updateState();
    });

    // ===== Confirmation Update =====
    function updateConfirmation() {
        $('confirmPartner').textContent = partnerName.value.trim() || '—';
        $('confirmCustomer').textContent = customerName.value.trim() || '—';
        if (bankNew.checked && bankInfoSaved && savedBankData) {
            $('confirmBank').innerHTML = `${savedBankData.bankName} ${savedBankData.branchName}<br>${savedBankData.accountType} ${savedBankData.accountNumber}`;
        } else if (bankExisting.checked) {
            $('confirmBank').textContent = '既に設定済み（入力不要）';
        } else {
            $('confirmBank').textContent = '未設定';
        }
    }
    partnerName.addEventListener('input', updateConfirmation);
    customerName.addEventListener('input', updateConfirmation);

    // ===== Progress & Validation =====
    function updateState() {
        updateConfirmation();

        const s1 = partnerName.value.trim() && customerName.value.trim();
        const s2 = true; // product always selected
        const s3 = cond1.checked && cond2.checked;
        const s4 = bankExisting.checked || (bankNew.checked && bankInfoSaved);

        $('prog1').className = 'progress-step ' + (s1 ? 'done' : 'active');
        $('prog2').className = 'progress-step ' + (s1 && s3 ? 'done' : (s1 ? 'active' : ''));
        $('prog3').className = 'progress-step ' + (s1 && s3 && s4 ? 'done' : (s1 && s3 ? 'active' : ''));
        $('prog4').className = 'progress-step ' + (s1 && s3 && s4 && finalCheck.checked ? 'done' : (s1 && s3 && s4 ? 'active' : ''));

        submitBtn.disabled = !(s1 && s3 && s4 && finalCheck.checked);
    }

    [partnerName, customerName].forEach(el => el.addEventListener('input', updateState));
    [cond1, cond2, finalCheck].forEach(el => el.addEventListener('change', updateState));

    // ===== Submit =====
    $('appForm').addEventListener('submit', async e => {
        e.preventDefault();
        if (submitBtn.disabled) return;

        const payload = {
            partnerName: partnerName.value.trim(),
            customerName: customerName.value.trim(),
            product: 'BakuApo（バクアポ）税込55万円',
            commission: 275000,
            bankStatus: bankExisting.checked ? 'existing' : 'new',
            bankInfo: savedBankData || null,
            paymentDate: getPaymentDate(),
            submittedAt: new Date().toISOString()
        };

        submitBtn.disabled = true;
        submitBtn.innerHTML = '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg> 送信中...';

        if (FORM_ENDPOINT) {
            try {
                await fetch(FORM_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    mode: 'no-cors'
                });
            } catch (err) {
                console.error('Submit error:', err);
            }
        }

        // Redirect to thanks page
        setTimeout(() => {
            const pName = encodeURIComponent(partnerName.value.trim());
            window.location.href = '/conversion-report/thanks/?name=' + pName;
        }, 800);
    });

    // Init
    updateState();

    // === Congrats Modal + Confetti ===
    (() => {
        const overlay = document.getElementById('congratsOverlay');
        const bar = document.getElementById('congratsBar');
        const closeBtn = document.getElementById('congratsClose');
        const canvas = document.getElementById('confettiCanvas');
        const ctx = canvas.getContext('2d');
        const DURATION = 4000;
        let startTime = null;
        let dismissed = false;

        requestAnimationFrame(() => overlay.classList.add('show'));

        function tickBar(now) {
            if (!startTime) startTime = now;
            const elapsed = now - startTime;
            const pct = Math.min(elapsed / DURATION * 100, 100);
            bar.style.width = pct + '%';
            if (elapsed < DURATION && !dismissed) {
                requestAnimationFrame(tickBar);
            } else if (!dismissed) {
                dismiss();
            }
        }
        requestAnimationFrame(tickBar);

        function dismiss() {
            if (dismissed) return;
            dismissed = true;
            overlay.classList.remove('show');
            overlay.classList.add('hide');
            setTimeout(() => overlay.remove(), 500);
        }
        closeBtn.addEventListener('click', dismiss);
        overlay.addEventListener('click', e => { if (e.target === overlay) dismiss(); });

        function resizeCanvas() {
            canvas.width = window.innerWidth * devicePixelRatio;
            canvas.height = window.innerHeight * devicePixelRatio;
            canvas.style.width = window.innerWidth + 'px';
            canvas.style.height = window.innerHeight + 'px';
            ctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        const colors = ['#0852FF','#635BFF','#10B981','#F59E0B','#EF4444','#EC4899','#8B5CF6','#06B6D4','#FF6B6B','#FFD93D'];
        const pieces = [];
        const W = () => window.innerWidth;
        const H = () => window.innerHeight;

        for (let i = 0; i < 120; i++) {
            pieces.push({
                x: Math.random() * W(),
                y: -Math.random() * H() * 0.8 - 20,
                w: 4 + Math.random() * 6,
                h: 6 + Math.random() * 10,
                color: colors[Math.floor(Math.random() * colors.length)],
                vx: (Math.random() - 0.5) * 2,
                vy: 1.5 + Math.random() * 3,
                rot: Math.random() * 360,
                rotV: (Math.random() - 0.5) * 8,
                alpha: 1,
                shape: Math.random() > 0.4 ? 'rect' : 'circle'
            });
        }

        let confettiDone = false;
        function drawConfetti() {
            ctx.clearRect(0, 0, W(), H());
            let alive = 0;
            for (const p of pieces) {
                p.x += p.vx;
                p.vy += 0.04;
                p.y += p.vy;
                p.rot += p.rotV;
                p.vx *= 0.999;
                if (p.y > H() + 40) {
                    p.alpha -= 0.02;
                    if (p.alpha <= 0) continue;
                }
                alive++;
                ctx.save();
                ctx.translate(p.x, p.y);
                ctx.rotate(p.rot * Math.PI / 180);
                ctx.globalAlpha = Math.max(0, p.alpha);
                ctx.fillStyle = p.color;
                if (p.shape === 'rect') {
                    ctx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
                } else {
                    ctx.beginPath();
                    ctx.arc(0, 0, p.w / 2, 0, Math.PI * 2);
                    ctx.fill();
                }
                ctx.restore();
            }
            if (alive > 0 && !confettiDone) {
                requestAnimationFrame(drawConfetti);
            } else {
                confettiDone = true;
                canvas.remove();
            }
        }
        requestAnimationFrame(drawConfetti);
    })();
    </script>
</body>
</html>
