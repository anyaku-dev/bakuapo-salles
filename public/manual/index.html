<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>パートナー様向けマニュアルサイト</title>
    <style>
        /* --- Base Variables & Reset --- */
        :root {
            --bg-color: #F7F7F5;
            --card-bg: #FFFFFF;
            --text-main: #37352F;
            --text-sub: #787774;
            --accent-color: #2383E2;
            --link-color: #0B6E99;
            --border-color: #E9E9E7;
            --tag-bg: #E3E2E0;
            --tag-text: #32302C;
            --star-color-on: #F2C94C;
            --star-color-off: #D3D1CB;
            --check-color-on: #27AE60;
            --check-color-off: #D3D1CB;
            --sidebar-width: 240px;
            --spacing-unit: 16px;
            --max-width: 1200px;
            
            /* アイコン色 */
            --icon-sheet: #0F9D58;
            --icon-doc: #4285F4;
            --icon-slide: #F4B400;
            --icon-pdf: #EA4335;
            --icon-web: #5F6368;

            /* Chatbot Variables */
            --chat-primary: #2383E2;
            --chat-bg: #FFFFFF;
            --chat-bubble-user: #2383E2;
            --chat-text-user: #FFFFFF;
            --chat-bubble-bot: #F0F0EF;
            --chat-text-bot: #37352F;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Hiragino Sans", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            line-height: 1.6;
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
        }

        .container {
            max-width: var(--max-width);
            margin: 0 auto;
            padding: 0 var(--spacing-unit);
            min-height: 100vh;
        }

        /* --- Header --- */
        header {
            padding-top: 32px;
            padding-bottom: 16px;
            background-color: var(--bg-color);
            position: sticky;
            top: 0;
            z-index: 100;
            transition: box-shadow 0.2s;
        }

        .title-area {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-bottom: 24px;
        }

        .logo { height: 40px; width: auto; object-fit: contain; }

        h1 {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-main);
        }

        /* --- Tabs --- */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 16px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-sub);
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }
        .tab-btn:hover { background-color: rgba(0,0,0,0.03); color: var(--text-main); }
        .tab-btn.active { color: var(--text-main); border-bottom-color: var(--text-main); }

        /* --- Search & Status --- */
        .controls-wrapper { margin-bottom: 0; }
        .search-container { position: relative; margin-bottom: 12px; }
        .search-input {
            width: 100%;
            padding: 12px 16px;
            padding-left: 40px;
            font-size: 15px;
            border: 1px solid rgba(55, 53, 47, 0.16);
            border-radius: 6px;
            background-color: var(--card-bg);
            color: var(--text-main);
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .search-input:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 2px rgba(35, 131, 226, 0.2); }
        .search-icon {
            position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
            width: 16px; height: 16px; fill: var(--text-sub); pointer-events: none;
        }

        .status-bar {
            display: flex; justify-content: space-between; align-items: center;
            font-size: 12px; color: var(--text-sub); height: 20px;
            margin-bottom: 8px;
        }
        .loading-indicator { display: none; align-items: center; gap: 6px; }
        .loading-indicator.active { display: flex; }
        .spinner {
            width: 12px; height: 12px; border: 2px solid var(--text-sub);
            border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- Layout --- */
        .main-layout {
            display: flex; gap: 32px; position: relative; align-items: flex-start;
        }

        .sidebar {
            width: var(--sidebar-width); flex-shrink: 0; position: sticky;
            max-height: calc(100vh - 200px); overflow-y: auto; padding-right: 8px;
            background-color: var(--bg-color); 
        }
        .sidebar::-webkit-scrollbar { width: 4px; }
        .sidebar::-webkit-scrollbar-thumb { background-color: rgba(0,0,0,0.1); border-radius: 4px; }

        .filter-section {
            margin-bottom: 24px; padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex; flex-direction: column; gap: 8px;
        }
        .filter-btn {
            display: flex; align-items: center; gap: 8px; width: 100%; padding: 8px 12px;
            background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 6px;
            cursor: pointer; font-size: 14px; font-weight: 600; color: var(--text-main);
            transition: all 0.2s; user-select: none;
        }
        .filter-btn:hover { background: #F0F0EF; }
        .filter-btn.active-star { background: #FFF9E6; border-color: #F2C94C; color: #946F00; }
        .filter-btn.active-star svg { fill: #F2C94C; stroke: #F2C94C; }
        .filter-btn.active-unwatched { background: #E8F5E9; border-color: #27AE60; color: #1E8449; }
        .filter-icon { width: 18px; height: 18px; fill: none; stroke: currentColor; stroke-width: 2; }

        .sidebar-title {
            font-size: 11px; font-weight: 600; text-transform: uppercase; color: var(--text-sub);
            margin-bottom: 8px; padding-left: 8px;
        }
        .category-nav-list { list-style: none; }
        .category-nav-item {
            font-size: 13px; color: var(--text-main); padding: 6px 8px;
            border-radius: 4px; cursor: pointer; transition: background 0.1s;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .category-nav-item:hover { background-color: rgba(55, 53, 47, 0.08); }

        .content-area { flex: 1; padding-bottom: 80px; min-width: 0; }
        .list-section { display: none; flex-direction: column; gap: 24px; }
        .list-section.active { display: flex; }

        /* --- Video Card Design --- */
        .card {
            background-color: var(--card-bg); border: 1px solid var(--border-color);
            border-radius: 8px; padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.02);
            scroll-margin-top: 280px; position: relative;
        }

        /* --- Drive File List Design --- */
        .drive-category-group { 
            margin-bottom: 40px; 
            scroll-margin-top: 280px; 
        }
        .drive-category-title {
            font-size: 22px; font-weight: 700; margin-bottom: 24px;
            padding-bottom: 8px; border-bottom: 2px solid var(--border-color);
            color: var(--text-main);
        }
        
        .drive-medium-block {
            margin-bottom: 24px;
            margin-left: 8px;
            padding-left: 20px;
            border-left: 3px solid var(--border-color);
        }
        
        .drive-medium-header {
            font-size: 17px; font-weight: 600; color: var(--text-main);
            display: flex; align-items: center; gap: 8px;
            margin-bottom: 12px;
            padding-top: 4px;
        }
        .folder-icon { width: 20px; height: 20px; fill: var(--text-sub); }

        .drive-small-group {
            margin-left: 12px;
            margin-bottom: 16px;
        }

        .drive-small-header {
            font-size: 14px; font-weight: 600; color: var(--text-sub);
            display: flex; align-items: center; gap: 6px;
            margin-bottom: 8px;
        }
        .small-icon { width: 14px; height: 14px; }

        .drive-file-list { 
            list-style: none; 
            margin-left: 12px;
            display: flex; flex-direction: column; gap: 8px;
        }
        .drive-file-list.direct-list { margin-left: 8px; margin-bottom: 24px; }

        .drive-file-item {
            display: flex; align-items: flex-start; justify-content: space-between;
            padding: 12px 16px; 
            background: #fff; border: 1px solid var(--border-color);
            border-radius: 6px;
            transition: all 0.2s; text-decoration: none; color: inherit;
        }
        .drive-file-item:hover { 
            background-color: #FAFAFA; 
            border-color: var(--accent-color);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .file-content-wrapper { display: flex; gap: 16px; flex: 1; min-width: 0; align-items: center; }
        
        .file-thumbnail {
            width: 60px; height: 60px; 
            background-color: #f9f9f9; border-radius: 6px;
            flex-shrink: 0; display: flex; align-items: center; justify-content: center;
            overflow: hidden; border: 1px solid var(--border-color);
        }
        .file-thumbnail img { width: 100%; height: 100%; object-fit: cover; }
        
        .icon-svg { width: 32px; height: 32px; }
        .type-sheet { color: var(--icon-sheet); }
        .type-doc { color: var(--icon-doc); }
        .type-pdf { color: var(--icon-pdf); }
        .type-slide { color: var(--icon-slide); }
        .type-web { color: var(--icon-web); }

        .file-info { display: flex; flex-direction: column; gap: 2px; justify-content: center; }
        .file-name {
            font-size: 15px; color: var(--text-main); font-weight: 600;
            line-height: 1.4;
        }
        .file-desc {
            font-size: 12px; color: var(--text-sub); line-height: 1.4; margin-top: 2px;
        }
        
        .drive-file-item:hover .file-name { color: var(--accent-color); }

        .action-buttons {
            display: flex; gap: 4px; margin-left: 12px; flex-shrink: 0;
            padding-top: 2px;
        }
        .card .action-buttons { position: absolute; top: 20px; right: 20px; }

        .icon-btn {
            background: none; border: none; cursor: pointer; padding: 4px;
            display: flex; align-items: center; justify-content: center;
            color: var(--star-color-off); transition: transform 0.1s;
        }
        .icon-btn:hover { transform: scale(1.1); }
        .icon-btn svg { width: 20px; height: 20px; fill: none; stroke: currentColor; stroke-width: 2; }
        
        .star-btn.active { color: var(--star-color-on); }
        .star-btn.active svg { fill: currentColor; stroke: currentColor; }

        .check-btn { color: var(--check-color-off); }
        .check-btn.active { color: var(--check-color-on); }
        
        .video-title { font-size: 18px; font-weight: 700; margin-bottom: 16px; padding-right: 80px; }
        .video-embed-container {
            position: relative; width: 100%; padding-bottom: 56.25%;
            background-color: #000; border-radius: 4px; overflow: hidden; margin-bottom: 16px;
        }
        .video-embed-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
        .description { font-size: 15px; white-space: pre-wrap; margin-bottom: 16px; word-wrap: break-word; }
        .material-btn {
            display: inline-flex; align-items: center; gap: 6px; font-size: 13px; color: var(--text-sub);
            background-color: #F0F0EF; padding: 8px 12px; border-radius: 4px; text-decoration: none;
        }
        .material-btn:hover { background-color: #E3E2E0; color: var(--text-main); }

        /* --- Q&A Card Design --- */
        .qa-card {
            background-color: var(--card-bg); border: 1px solid var(--border-color);
            border-radius: 8px; padding: 0; margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.02); overflow: hidden;
        }
        .qa-question {
            display: flex; align-items: flex-start; gap: 12px; padding: 20px 24px;
            font-weight: 600; font-size: 15px; line-height: 1.6;
            background-color: #FAFAFA; border-bottom: 1px solid var(--border-color);
            position: relative;
        }
        .qa-question .action-buttons { position: absolute; top: 16px; right: 16px; }
        .qa-answer {
            display: flex; align-items: flex-start; gap: 12px; padding: 20px 24px;
            font-size: 15px; line-height: 1.8; white-space: pre-wrap; color: var(--text-main);
        }
        .qa-badge {
            flex-shrink: 0; display: inline-flex; align-items: center; justify-content: center;
            width: 28px; height: 28px; border-radius: 50%; font-size: 13px; font-weight: 700;
            margin-top: 1px;
        }
        .qa-badge-q { background-color: #2383E2; color: #fff; }
        .qa-badge-a { background-color: #27AE60; color: #fff; }

        /* --- Rebuttal Card Design --- */
        .rebuttal-card { border-left: 4px solid #E74C3C; }
        .rebuttal-objection { background-color: #FFF5F5; }
        .rebuttal-badge-obj { background-color: #E74C3C; color: #fff; font-size: 10px; width: auto; padding: 4px 8px; border-radius: 4px; }
        .rebuttal-badge-res { background-color: #2383E2; color: #fff; font-size: 10px; width: auto; padding: 4px 8px; border-radius: 4px; }

        .message-state { text-align: center; padding: 40px; color: var(--text-sub); }
        .error-container { display: none; flex-direction: column; gap: 8px; margin-bottom: 20px; }
        .error-message { color: #c0392b; background: #ffe0e0; padding: 12px; border-radius: 6px; font-size: 13px; }

        /* --- Chatbot Widget Styles --- */
        .chat-widget {
            position: fixed; bottom: 24px; right: 24px; z-index: 1000;
            display: flex; flex-direction: column; align-items: flex-end;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }
        .chat-toggle-btn {
            height: 56px; padding: 0 24px 0 20px; border-radius: 30px;
            background-color: var(--chat-primary); color: white; border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 12px;
            transition: transform 0.2s, background-color 0.2s; font-weight: 700; font-size: 15px;
        }
        .chat-toggle-btn:hover { transform: scale(1.05); background-color: #1a6fb5; }
        .chat-toggle-btn svg { width: 24px; height: 24px; fill: currentColor; }
        .chat-btn-text { display: block; }

        .chat-window {
            position: absolute; bottom: 72px; right: 0; width: 350px; height: 500px;
            background-color: var(--chat-bg); border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15); border: 1px solid var(--border-color);
            display: none; flex-direction: column; overflow: hidden;
            transform-origin: bottom right; transition: opacity 0.2s, transform 0.2s;
        }
        .chat-window.active { display: flex; }

        .chat-header {
            padding: 16px; background-color: var(--bg-color); border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
        }
        .chat-title { font-weight: 700; font-size: 15px; color: var(--text-main); }
        .chat-close { background: none; border: none; cursor: pointer; color: var(--text-sub); }

        .chat-messages {
            flex: 1; padding: 16px; overflow-y: auto; background-color: #FFFFFF;
            display: flex; flex-direction: column; gap: 12px;
        }
        .chat-msg {
            max-width: 85%; padding: 10px 14px; border-radius: 12px; font-size: 14px; line-height: 1.5; word-wrap: break-word;
        }
        .chat-msg.bot { align-self: flex-start; background-color: var(--chat-bubble-bot); color: var(--chat-text-bot); border-bottom-left-radius: 2px; }
        .chat-msg.user { align-self: flex-end; background-color: var(--chat-bubble-user); color: var(--chat-text-user); border-bottom-right-radius: 2px; }
        .chat-msg.system { align-self: center; background-color: #fdf2f2; color: #c53030; border: 1px solid #fc8181; font-size: 12px; text-align: left; max-width: 90%; }
        .chat-msg b, .chat-msg strong { font-weight: 700; color: #2c2c2c; }
        .chat-msg a { color: #2383E2; text-decoration: underline; word-break: break-all; }
        .chat-msg a:hover { text-decoration: none; opacity: 0.8; }

        .chat-input-area {
            padding: 12px; border-top: 1px solid var(--border-color);
            display: flex; gap: 8px; background-color: var(--bg-color);
        }
        .chat-input {
            flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 20px; font-size: 14px; outline: none; transition: all 0.2s;
        }
        .chat-input:focus { border-color: var(--accent-color); }
        .chat-input:disabled { background-color: #f3f3f3; cursor: not-allowed; }
        .chat-send-btn { background: none; border: none; cursor: pointer; color: var(--accent-color); padding: 4px; }
        .chat-send-btn:disabled { color: var(--text-sub); cursor: not-allowed; }

        .typing-dots { display: flex; gap: 4px; padding: 4px 8px; }
        .typing-dot { width: 6px; height: 6px; background-color: #aaa; border-radius: 50%; animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        @media (max-width: 768px) {
            header { padding-top: 12px; }
            .title-area { justify-content: flex-start; }
            h1 { font-size: 16px; }
            .logo { height: 24px; }
            .status-bar { display: none; }
            .main-layout { flex-direction: column; gap: 16px; }
            .sidebar {
                position: sticky; z-index: 90; width: calc(100% + 32px); margin-left: -16px;
                padding: 8px 16px; border-bottom: 1px solid var(--border-color);
                max-height: none; overflow-x: auto; display: flex; align-items: center; gap: 8px;
            }
            .sidebar::-webkit-scrollbar { display: none; }
            .filter-section {
                flex-direction: row; margin: 0; padding: 0; border: none;
                padding-right: 8px; margin-right: 4px; border-right: 1px solid var(--border-color);
            }
            .filter-btn { padding: 6px 10px; width: auto; font-size: 11px; white-space: nowrap; }
            .sidebar-title { display: none; }
            .category-nav-list { display: flex; gap: 8px; }
            .category-nav-item { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 20px; padding: 6px 12px; font-size: 12px; }
            .card { scroll-margin-top: 250px; }
            .drive-category-group { scroll-margin-top: 250px; }
            
            .drive-medium-block { margin-left: 0; padding-left: 12px; border-left-width: 2px; }
            .drive-file-list { margin-left: 0; }
            .file-thumbnail { width: 50px; height: 50px; }
            .file-name { font-size: 14px; }
            .icon-svg { width: 24px; height: 24px; }

            .chat-toggle-btn { width: 56px; height: 56px; border-radius: 50%; padding: 0; }
            .chat-btn-text { display: none; }
            .chat-window { width: calc(100vw - 32px); right: -8px; bottom: 80px; height: 60vh; }
        }
    </style>
</head>
<body>

<div class="container">
    <header id="mainHeader">
        <div class="title-area">
            <img src="logo-main.png" alt="Logo" class="logo" onerror="this.style.display='none'">
            <h1>パートナー様向けマニュアルサイト</h1>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('video')" data-tab="video">動画マニュアル</button>
            <button class="tab-btn" onclick="switchTab('drive')" data-tab="drive">資料ドライブ</button>
            <button class="tab-btn" onclick="switchTab('qa')" data-tab="qa">Q&A</button>
            <button class="tab-btn" onclick="switchTab('rebuttal')" data-tab="rebuttal">反論対策</button>
        </div>

        <div class="controls-wrapper">
            <div class="search-container">
                <svg class="search-icon" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                <input type="text" id="searchInput" class="search-input" placeholder="検索...">
            </div>
            <div id="errorContainer" class="error-container"></div>
            <div class="status-bar">
                <span id="countDisplay">0件</span>
                <div class="loading-indicator" id="loadingIndicator"><div class="spinner"></div><span>更新中...</span></div>
            </div>
        </div>
    </header>

    <div class="main-layout">
        <aside class="sidebar" id="stickySidebar">
            <div class="filter-section">
                <div class="filter-btn" id="starFilterBtn" onclick="toggleStarFilter()">
                    <svg class="filter-icon" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                    <span>スター付きのみ</span>
                </div>
                <div class="filter-btn" id="unwatchedFilterBtn" onclick="toggleUnwatchedFilter()">
                    <svg class="filter-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                    <span id="unwatchedText">未視聴のみ表示</span>
                </div>
            </div>
            <div class="sidebar-title">カテゴリー目次</div>
            <ul class="category-nav-list" id="categoryNav"></ul>
        </aside>

        <main class="content-area">
            <div id="list-video" class="list-section active"></div>
            <div id="list-drive" class="list-section"></div>
            <div id="list-qa" class="list-section"></div>
            <div id="list-rebuttal" class="list-section"></div>
        </main>
    </div>

    <div class="chat-widget">
        <button class="chat-toggle-btn" onclick="toggleChat()" title="AIアシスタントに質問">
            <svg viewBox="0 0 24 24"><path d="M20 9V7c0-1.1-.9-2-2-2h-3c0-1.66-1.34-3-3-3S9 3.34 9 5H6c-1.1 0-2 .9-2 2v2c-1.66 0-3 1.34-3 3s1.34 3 3 3v4c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-4c1.66 0 3-1.34 3-3s-1.34-3-3-3zm-2 10H6v-4h12v4zm0-6H6V7h12v6z"/><circle cx="8.5" cy="10.5" r="1.5"/><circle cx="15.5" cy="10.5" r="1.5"/></svg>
            <span class="chat-btn-text">AIに質問する</span>
        </button>

        <div class="chat-window" id="chatWindow">
            <div class="chat-header">
                <span class="chat-title">AIパートナーアシスタント</span>
                <button class="chat-close" onclick="toggleChat()">✕</button>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="chat-msg bot">
                    こんにちは！<br>動画マニュアル、資料、Q&A、切り返しトークについて、ご質問があればお答えします。
                </div>
            </div>
            <div class="chat-input-area">
                <input type="text" id="chatInput" class="chat-input" placeholder="質問を入力..." onkeypress="handleChatKey(event)">
                <button class="chat-send-btn" onclick="sendChatMessage()" id="chatSendBtn">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    const CONFIG = {
        geminiApiKey: "AIzaSyBxxrrp9_VZaToi63RHLij2xGg8Aov1vWo", 
        // 表示用データソース
        videoSheetUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBVuXb-cTydLU-CMFwHyYnsJfg9e2AsTEa4TU1G9nYQlShkZHv3wGM2a1X5ww81o5v8HZNS9IXUI1b/pub?gid=396280088&single=true&output=csv",
        driveSheetUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBVuXb-cTydLU-CMFwHyYnsJfg9e2AsTEa4TU1G9nYQlShkZHv3wGM2a1X5ww81o5v8HZNS9IXUI1b/pub?gid=380310918&single=true&output=csv",
        
        // Q&A・反論対策データソース
        qaSheetUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBVuXb-cTydLU-CMFwHyYnsJfg9e2AsTEa4TU1G9nYQlShkZHv3wGM2a1X5ww81o5v8HZNS9IXUI1b/pub?gid=1192474135&single=true&output=csv",
        rebuttalSheetUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBVuXb-cTydLU-CMFwHyYnsJfg9e2AsTEa4TU1G9nYQlShkZHv3wGM2a1X5ww81o5v8HZNS9IXUI1b/pub?gid=1328585848&single=true&output=csv",

        refreshInterval: 60000 
    };

    const THRESHOLDS = { CONFIDENCE: 0.6, SUGGESTION: 0.25 };

    const state = {
        currentTab: 'video',
        searchText: '',
        showStarredOnly: false,
        showUnwatchedOnly: false,
        starredItems: new Set(),
        watchedItems: new Set(),
        data: { video: [], drive: [], qa: [], rebuttal: [] },
        isLoaded: { video: false, drive: false, qa: false, rebuttal: false },
        hasError: false,
        // Chat
        chatHistory: [],
        messageTimestamps: [],
        lockedUntil: 0
    };

    const els = {
        tabs: document.querySelectorAll('.tab-btn'),
        input: document.getElementById('searchInput'),
        count: document.getElementById('countDisplay'),
        loading: document.getElementById('loadingIndicator'),
        errorContainer: document.getElementById('errorContainer'),
        categoryNav: document.getElementById('categoryNav'),
        header: document.getElementById('mainHeader'),
        sidebar: document.getElementById('stickySidebar'),
        starFilterBtn: document.getElementById('starFilterBtn'),
        unwatchedFilterBtn: document.getElementById('unwatchedFilterBtn'),
        unwatchedText: document.getElementById('unwatchedText'),
        lists: {
            video: document.getElementById('list-video'),
            drive: document.getElementById('list-drive'),
            qa: document.getElementById('list-qa'),
            rebuttal: document.getElementById('list-rebuttal')
        },
        // Chat
        chatWindow: document.getElementById('chatWindow'),
        chatMessages: document.getElementById('chatMessages'),
        chatInput: document.getElementById('chatInput'),
        chatSendBtn: document.getElementById('chatSendBtn')
    };

    function updateLayoutMetrics() {
        const headerHeight = els.header.offsetHeight;
        const isMobile = window.innerWidth <= 768;
        const topOffset = isMobile ? headerHeight : headerHeight + 20;
        els.sidebar.style.top = `${topOffset}px`;
        const totalStickyHeight = isMobile ? topOffset + els.sidebar.offsetHeight + 20 : topOffset;
        document.querySelectorAll('.card, .drive-category-group').forEach(el => {
            el.style.scrollMarginTop = `${totalStickyHeight}px`;
        });
    }

    function loadUserPreferences() {
        try {
            const stars = localStorage.getItem('partner_manual_stars_v2');
            if (stars) state.starredItems = new Set(JSON.parse(stars));
            const watched = localStorage.getItem('partner_manual_watched_v2');
            if (watched) state.watchedItems = new Set(JSON.parse(watched));
        } catch (e) {}
    }

    function saveUserPreferences() {
        localStorage.setItem('partner_manual_stars_v2', JSON.stringify([...state.starredItems]));
        localStorage.setItem('partner_manual_watched_v2', JSON.stringify([...state.watchedItems]));
    }

    function switchTab(tab) {
        state.currentTab = tab;
        els.tabs.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tab));
        Object.keys(els.lists).forEach(key => {
            els.lists[key].classList.toggle('active', key === tab);
        });
        const labelMap = { video: '未視聴のみ表示', drive: '未確認のみ表示', qa: '未確認のみ表示', rebuttal: '未確認のみ表示' };
        els.unwatchedText.textContent = labelMap[tab] || '未確認のみ表示';
        renderView();
    }

    function toggleStar(key) {
        if (state.starredItems.has(key)) state.starredItems.delete(key);
        else state.starredItems.add(key);
        saveUserPreferences();
        renderView();
    }

    function toggleWatched(key) {
        if (state.watchedItems.has(key)) state.watchedItems.delete(key);
        else state.watchedItems.add(key);
        saveUserPreferences();
        renderView();
    }

    function toggleStarFilter() {
        state.showStarredOnly = !state.showStarredOnly;
        els.starFilterBtn.classList.toggle('active-star', state.showStarredOnly);
        renderView();
    }

    function toggleUnwatchedFilter() {
        state.showUnwatchedOnly = !state.showUnwatchedOnly;
        els.unwatchedFilterBtn.classList.toggle('active-unwatched', state.showUnwatchedOnly);
        renderView();
    }

    function parseCSV(text) {
        const arr = []; let quote = false; let row = []; let col = ''; let c = 0;
        for (; c < text.length; c++) {
            let cc = text[c], nc = text[c+1];
            if (quote) {
                if (cc === '"') { if (nc === '"') { col += '"'; c++; } else { quote = false; } } else { col += cc; }
            } else {
                if (cc === '"') { quote = true; }
                else if (cc === ',') { row.push(col); col = ''; }
                else if (cc === '\r' && nc === '\n') { row.push(col); col = ''; arr.push(row); row = []; c++; }
                else if (cc === '\n' || cc === '\r') { row.push(col); col = ''; arr.push(row); row = []; }
                else { col += cc; }
            }
        }
        if (col.length > 0 || row.length > 0) { row.push(col); arr.push(row); }
        return arr;
    }

    function extractYoutubeId(url) {
        if (!url) return null;
        const match = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/);
        return (match && match[2].length === 11) ? match[2] : null;
    }

    function getFileType(url) {
        if (!url) return 'web';
        const lower = url.toLowerCase();
        if (extractYoutubeId(url)) return 'youtube';
        if (lower.includes('spreadsheets')) return 'sheet';
        if (lower.includes('document')) return 'doc';
        if (lower.includes('presentation')) return 'slide';
        if (lower.endsWith('.pdf') || lower.includes('drive.google.com')) return 'pdf';
        return 'web';
    }

    function getFileIconSvg(type) {
        let className = 'icon-svg';
        let svgPath = '';
        switch(type) {
            case 'sheet': className += ' type-sheet'; svgPath = '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/>'; break;
            case 'doc': className += ' type-doc'; svgPath = '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/>'; break;
            case 'slide': className += ' type-slide'; svgPath = '<rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/>'; break;
            case 'pdf': className += ' type-pdf'; svgPath = '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><path d="M9 13v-1h3v1"/><path d="M12 18v-6"/><path d="M9 17h3"/>'; break;
            default: className += ' type-web'; svgPath = '<circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>'; break;
        }
        return `<svg class="${className}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">${svgPath}</svg>`;
    }

    async function fetchAllData() {
        els.loading.classList.add('active');
        els.errorContainer.style.display = 'none';

        try {
            // 1. Video (Manual)
            const vRes = await fetch(`${CONFIG.videoSheetUrl}&t=${Date.now()}`);
            if (vRes.ok) {
                const vText = await vRes.text();
                const vRows = parseCSV(vText).slice(1).filter(r => (r[0]||'').toUpperCase() === 'ON');
                state.data.video = vRows.map(r => ({
                    sourceType: 'manual',
                    id: r[2] || r[3],
                    category: r[1] || '未分類',
                    youtubeUrl: r[2], title: r[3], desc: r[4], materialUrl: r[5]
                }));
                state.isLoaded.video = true;
            }

            // 2. Drive (Material)
            const dRes = await fetch(`${CONFIG.driveSheetUrl}&t=${Date.now()}`);
            if (dRes.ok) {
                const dText = await dRes.text();
                const dRows = parseCSV(dText).slice(1).filter(r => (r[0]||'').toUpperCase() === 'ON');
                state.data.drive = dRows.map(r => ({
                    sourceType: 'material',
                    id: r[5] || '#',
                    large: r[1] || 'その他', medium: r[2] || '', small: r[3] || '', detail: r[4] || '',
                    url: r[5] || '#', desc: r[6] || ''
                }));
                state.isLoaded.drive = true;
            }

            // 3. QA (Background for AI)
            const qRes = await fetch(`${CONFIG.qaSheetUrl}&t=${Date.now()}`);
            if (qRes.ok) {
                const qText = await qRes.text();
                const qRows = parseCSV(qText).slice(1).filter(r => (r[0]||'').toUpperCase() === 'ON');
                state.data.qa = qRows.map((r, i) => ({
                    sourceType: 'qa',
                    id: `qa-${r[2] || i}`,
                    category: r[1] || '未分類', question: r[2] || '', answer: r[3] || ''
                }));
                state.isLoaded.qa = true;
            }

            // 4. Rebuttal (Background for AI)
            const rRes = await fetch(`${CONFIG.rebuttalSheetUrl}&t=${Date.now()}`);
            if (rRes.ok) {
                const rText = await rRes.text();
                const rRows = parseCSV(rText).slice(1).filter(r => (r[0]||'').toUpperCase() === 'ON');
                state.data.rebuttal = rRows.map((r, i) => ({
                    sourceType: 'qa', // Treat as QA for AI
                    id: `rebuttal-${r[2] || i}`,
                    category: r[1] || '未分類', question: r[2] || '', answer: r[3] || ''
                }));
                state.isLoaded.rebuttal = true;
            }

        } catch (e) {
            console.error(e);
            state.hasError = true;
            els.errorContainer.style.display = 'flex';
            els.errorContainer.innerHTML = `<div class="error-message">データの更新に失敗しました。</div>`;
        }
        
        renderView();
        els.loading.classList.remove('active');
    }

    function renderView() {
        const tab = state.currentTab;
        const container = els.lists[tab];
        container.innerHTML = '';
        els.categoryNav.innerHTML = '';

        const sourceData = state.data[tab];
        const query = state.searchText.toLowerCase().trim();
        
        if (!state.isLoaded[tab]) {
            container.innerHTML = `<div class="message-state">読み込み中...</div>`;
            return;
        }

        const filtered = sourceData.filter(item => {
            if (state.showStarredOnly && !state.starredItems.has(item.id)) return false;
            if (state.showUnwatchedOnly && state.watchedItems.has(item.id)) return false;
            if (!query) return true;
            return JSON.stringify(item).toLowerCase().includes(query);
        });

        els.count.textContent = `${filtered.length}件`;

        if (filtered.length === 0) {
            container.innerHTML = `<div class="message-state">該当なし</div>`;
            return;
        }

        if (tab === 'video') {
            renderVideoList(filtered, container);
        } else if (tab === 'drive') {
            renderDriveList(filtered, container);
        } else if (tab === 'qa') {
            renderQAList(filtered, container);
        } else if (tab === 'rebuttal') {
            renderRebuttalList(filtered, container);
        }

        requestAnimationFrame(updateLayoutMetrics);
    }

    function renderVideoList(items, container) {
        const categories = new Set();
        const catMap = {};
        items.forEach((item, idx) => {
            const card = document.createElement('article');
            card.className = 'card';
            card.id = `video-${idx}`;
            if (!categories.has(item.category)) {
                categories.add(item.category);
                catMap[item.category] = card.id;
            }
            card.innerHTML += `<div class="category-badge">${item.category}</div>`;
            const actions = createActionButtons(item.id);
            card.appendChild(actions);
            const h3 = document.createElement('h3');
            h3.className = 'video-title';
            h3.textContent = item.title;
            card.appendChild(h3);
            const vidId = extractYoutubeId(item.youtubeUrl);
            if (vidId) {
                card.innerHTML += `<div class="video-embed-container"><iframe src="https://www.youtube.com/embed/${vidId}" loading="lazy" allowfullscreen></iframe></div>`;
            }
            if (item.desc) card.innerHTML += `<div class="description">${item.desc}</div>`;
            if (item.materialUrl) {
                card.innerHTML += `<a href="${item.materialUrl}" target="_blank" class="material-btn"><svg viewBox="0 0 24 24" class="filter-icon"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg><span>テキスト資料</span></a>`;
            }
            container.appendChild(card);
        });
        renderNav(categories, catMap);
    }

    function renderQAList(items, container) {
        const categories = new Set();
        const catMap = {};
        const grouped = {};
        items.forEach(item => {
            const cat = item.category || '未分類';
            if (!grouped[cat]) grouped[cat] = [];
            grouped[cat].push(item);
        });
        let idx = 0;
        Object.keys(grouped).forEach(cat => {
            categories.add(cat);
            const catId = `qa-cat-${idx++}`;
            catMap[cat] = catId;
            const section = document.createElement('div');
            section.className = 'drive-category-group';
            section.id = catId;
            section.innerHTML = `<h2 class="drive-category-title">${cat}</h2>`;
            grouped[cat].forEach(item => {
                const card = document.createElement('div');
                card.className = 'qa-card';
                const actions = createActionButtons(item.id);
                card.innerHTML = `
                    <div class="qa-question"><span class="qa-badge qa-badge-q">Q</span><span>${item.question}</span></div>
                    <div class="qa-answer"><span class="qa-badge qa-badge-a">A</span><span>${item.answer}</span></div>
                `;
                card.querySelector('.qa-question').appendChild(actions);
                section.appendChild(card);
            });
            container.appendChild(section);
        });
        renderNav(categories, catMap);
    }

    function renderRebuttalList(items, container) {
        const categories = new Set();
        const catMap = {};
        const grouped = {};
        items.forEach(item => {
            const cat = item.category || '未分類';
            if (!grouped[cat]) grouped[cat] = [];
            grouped[cat].push(item);
        });
        let idx = 0;
        Object.keys(grouped).forEach(cat => {
            categories.add(cat);
            const catId = `rebuttal-cat-${idx++}`;
            catMap[cat] = catId;
            const section = document.createElement('div');
            section.className = 'drive-category-group';
            section.id = catId;
            section.innerHTML = `<h2 class="drive-category-title">${cat}</h2>`;
            grouped[cat].forEach(item => {
                const card = document.createElement('div');
                card.className = 'qa-card rebuttal-card';
                const actions = createActionButtons(item.id);
                card.innerHTML = `
                    <div class="qa-question rebuttal-objection"><span class="qa-badge rebuttal-badge-obj">反論</span><span>${item.question}</span></div>
                    <div class="qa-answer rebuttal-response"><span class="qa-badge rebuttal-badge-res">切返し</span><span>${item.answer}</span></div>
                `;
                card.querySelector('.qa-question').appendChild(actions);
                section.appendChild(card);
            });
            container.appendChild(section);
        });
        renderNav(categories, catMap);
    }

    function renderDriveList(items, container) {
        const tree = {};
        const largeCategories = new Set();
        const catFirstId = {};

        items.forEach(item => {
            const large = item.large || 'その他';
            let nameToDisplay = '';
            
            if (!tree[large]) tree[large] = { _files_: [], mediums: {} };
            largeCategories.add(large);

            if (item.detail && item.detail.trim() !== "") {
                const medium = item.medium || '未分類';
                const small = item.small || '未分類';
                nameToDisplay = item.detail;
                if (!tree[large].mediums[medium]) tree[large].mediums[medium] = { _files_: [], smalls: {} };
                if (!tree[large].mediums[medium].smalls[small]) tree[large].mediums[medium].smalls[small] = [];
                tree[large].mediums[medium].smalls[small].push({ ...item, displayName: nameToDisplay });
            } else if (item.small && item.small.trim() !== "") {
                const medium = item.medium || '未分類';
                nameToDisplay = item.small;
                if (!tree[large].mediums[medium]) tree[large].mediums[medium] = { _files_: [], smalls: {} };
                tree[large].mediums[medium]._files_.push({ ...item, displayName: nameToDisplay });
            } else if (item.medium && item.medium.trim() !== "") {
                nameToDisplay = item.medium;
                tree[large]._files_.push({ ...item, displayName: nameToDisplay });
            } else {
                nameToDisplay = large;
                tree[large]._files_.push({ ...item, displayName: nameToDisplay });
            }
        });

        let idx = 0;
        largeCategories.forEach(large => {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'drive-category-group';
            const catId = `drive-cat-${idx++}`;
            groupDiv.id = catId;
            catFirstId[large] = catId;

            const title = document.createElement('h2');
            title.className = 'drive-category-title';
            title.textContent = large;
            groupDiv.appendChild(title);

            const largeData = tree[large];

            if (largeData._files_.length > 0) {
                const ul = createFileList(largeData._files_);
                ul.classList.add('direct-list');
                groupDiv.appendChild(ul);
            }

            Object.keys(largeData.mediums).forEach(med => {
                const medData = largeData.mediums[med];
                const medBlock = document.createElement('div');
                medBlock.className = 'drive-medium-block';
                
                medBlock.innerHTML = `<div class="drive-medium-header"><svg class="folder-icon" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg><span>${med}</span></div>`;

                if (medData._files_.length > 0) {
                    const ul = createFileList(medData._files_);
                    ul.classList.add('direct-list');
                    medBlock.appendChild(ul);
                }

                Object.keys(medData.smalls).forEach(small => {
                    const files = medData.smalls[small];
                    if (files.length > 0) {
                        const smallGroup = document.createElement('div');
                        smallGroup.className = 'drive-small-group';
                        const smallHeader = document.createElement('div');
                        smallHeader.className = 'drive-small-header';
                        smallHeader.innerHTML = `<svg class="small-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/></svg>${small}`;
                        smallGroup.appendChild(smallHeader);
                        smallGroup.appendChild(createFileList(files));
                        medBlock.appendChild(smallGroup);
                    }
                });

                groupDiv.appendChild(medBlock);
            });
            container.appendChild(groupDiv);
        });
        renderNav(largeCategories, catFirstId);
    }

    function createFileList(files) {
        const ul = document.createElement('ul');
        ul.className = 'drive-file-list';
        files.forEach(file => {
            const li = document.createElement('a');
            li.href = file.url;
            li.target = "_blank";
            li.rel = "noopener noreferrer";
            li.className = 'drive-file-item';
            
            const wrapper = document.createElement('div');
            wrapper.className = 'file-content-wrapper';

            const type = getFileType(file.url);
            const thumbDiv = document.createElement('div');
            thumbDiv.className = 'file-thumbnail';
            if (type === 'youtube') {
                const ytId = extractYoutubeId(file.url);
                const img = document.createElement('img');
                img.src = `https://img.youtube.com/vi/${ytId}/mqdefault.jpg`;
                img.onerror = () => { thumbDiv.innerHTML = getFileIconSvg('web'); };
                thumbDiv.appendChild(img);
            } else {
                thumbDiv.innerHTML = getFileIconSvg(type);
            }
            wrapper.appendChild(thumbDiv);

            const info = document.createElement('div');
            info.className = 'file-info';
            const mainText = file.displayName;
            const subText = file.desc;
            info.innerHTML = `<div class="file-name">${mainText}</div>`;
            if(subText) info.innerHTML += `<div class="file-desc">${subText}</div>`;
            
            wrapper.appendChild(info);
            li.appendChild(wrapper);

            const actions = createActionButtons(file.id);
            actions.onclick = (e) => { e.preventDefault(); e.stopPropagation(); };
            li.appendChild(actions);
            ul.appendChild(li);
        });
        return ul;
    }

    function createActionButtons(id) {
        const div = document.createElement('div');
        div.className = 'action-buttons';
        const isStarred = state.starredItems.has(id);
        const isWatched = state.watchedItems.has(id);
        div.innerHTML = `
            <button class="icon-btn star-btn ${isStarred?'active':''}" onclick="toggleStar('${id}')">
                <svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
            </button>
            <button class="icon-btn check-btn ${isWatched?'active':''}" onclick="toggleWatched('${id}')">
                <svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
            </button>
        `;
        return div;
    }

    function renderNav(categories, idMap) {
        const frag = document.createDocumentFragment();
        categories.forEach(cat => {
            const li = document.createElement('li');
            li.className = 'category-nav-item';
            li.textContent = cat;
            li.onclick = () => {
                const el = document.getElementById(idMap[cat]);
                if(el) el.scrollIntoView({behavior:'smooth', block:'start'});
            };
            frag.appendChild(li);
        });
        els.categoryNav.appendChild(frag);
    }

    /* --- Chatbot Functions --- */
    function toggleChat() {
        els.chatWindow.classList.toggle('active');
        if (els.chatWindow.classList.contains('active')) {
            els.chatInput.focus();
            scrollToBottom();
        }
    }

    function handleChatKey(e) { if (e.key === 'Enter') sendChatMessage(); }
    function scrollToBottom() { els.chatMessages.scrollTop = els.chatMessages.scrollHeight; }

    function formatChatMessage(text) {
        if (!text) return "";
        let formatted = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        formatted = formatted.replace(/\[([^\]]+)\]\((https?:\/\/[^\s\)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
        formatted = formatted.replace(/(?<!href="|">)(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer">リンク</a>');
        formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<b class="font-bold">$1</b>');
        formatted = formatted.replace(/\n/g, '<br>');
        return formatted;
    }

    function addMessage(text, type, appendHtml = "") {
        const div = document.createElement('div');
        div.className = `chat-msg ${type}`;
        div.innerHTML = formatChatMessage(text) + appendHtml;
        els.chatMessages.appendChild(div);
        scrollToBottom();
    }

    function addTypingIndicator() {
        const div = document.createElement('div');
        div.className = 'chat-msg bot typing-indicator';
        div.innerHTML = `<div class="typing-dots"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`;
        els.chatMessages.appendChild(div);
        scrollToBottom();
        return div;
    }

    function setInputLock(locked) {
        els.chatInput.disabled = locked;
        els.chatSendBtn.disabled = locked;
        els.chatInput.placeholder = locked ? "送信制限中です (3分間)" : "質問を入力...";
    }

    function calculateSimilarity(str1, str2) {
        if (!str1 || !str2) return 0.0;
        const s1 = str1.toLowerCase().replace(/\s+/g, "");
        const s2 = str2.toLowerCase().replace(/\s+/g, "");
        if (s1 === s2) return 1.0;
        if (s1.length < 2 || s2.length < 2) return 0.0;
        const getBigrams = (str) => {
            const bigrams = [];
            for (let i = 0; i < str.length - 1; i++) { bigrams.push(str.substring(i, i + 2)); }
            return bigrams;
        };
        const bg1 = getBigrams(s1);
        const bg2 = getBigrams(s2);
        let intersection = 0;
        const bg2Copy = [...bg2];
        for (const pair of bg1) {
            const idx = bg2Copy.indexOf(pair);
            if (idx !== -1) { intersection++; bg2Copy.splice(idx, 1); }
        }
        return (2.0 * intersection) / (bg1.length + bg2.length);
    }

    function findBestContextWithFuzzyLogic(query) {
        const allItems = [
            ...state.data.video, 
            ...state.data.drive,
            ...state.data.qa,
            ...state.data.rebuttal
        ];
        
        let bestMatch = null;
        let highestScore = 0.0;

        allItems.forEach(item => {
            let targetText = "";
            let displayText = "";

            if (item.sourceType === 'manual') {
                targetText = `${item.category} ${item.title}`;
                displayText = `[動画: ${item.title}] 内容: ${item.desc}`;
            } else if (item.sourceType === 'material') {
                targetText = `${item.large} ${item.medium} ${item.small} ${item.detail} ${item.desc}`;
                // Drive items don't have a single 'title' field in data structure, using combination
                const name = item.detail || item.small || item.medium || item.large;
                displayText = `[資料: ${name}] 内容: ${item.desc}`;
            } else {
                targetText = `${item.question}`;
                displayText = `[QA] Q: ${item.question}\nA: ${item.answer}`;
            }

            const score = calculateSimilarity(query, targetText);
            if (score > highestScore) {
                highestScore = score;
                bestMatch = { item, score, displayText };
            }
        });
        return bestMatch;
    }

    async function sendChatMessage() {
        const now = Date.now();
        if (state.lockedUntil > now) return;

        const text = els.chatInput.value.trim();
        if (!text) return;
        
        // Spam prevention
        const LIMIT_COUNT = 8;
        const LIMIT_WINDOW = 3 * 60 * 1000;
        state.messageTimestamps = state.messageTimestamps.filter(t => t > now - LIMIT_WINDOW);
        
        if (state.messageTimestamps.length >= LIMIT_COUNT) {
            state.lockedUntil = now + LIMIT_WINDOW;
            const lockMsg = '連続で質問をしすぎているようです。しばらく経ってから再度お試しください。<br>または、<a href="https://lin.ee/0rNANZ7" target="_blank" rel="noopener noreferrer">事務局へ連絡</a>';
            addMessage(lockMsg, 'system');
            els.chatInput.value = '';
            setInputLock(true);
            setTimeout(() => { if (Date.now() >= state.lockedUntil) { setInputLock(false); state.lockedUntil = 0; } }, LIMIT_WINDOW);
            return;
        }

        if (!CONFIG.geminiApiKey) { alert("APIキーが設定されていません。"); return; }
        state.messageTimestamps.push(now);
        addMessage(text, 'user');
        els.chatInput.value = '';
        const loadingDiv = addTypingIndicator();

        try {
            const bestContext = findBestContextWithFuzzyLogic(text);
            const score = bestContext ? bestContext.score : 0;
            let prompt = "";
            const commonInstruction = `\n[AIの振る舞い・回答ルール]\n1. 機能に関する質問: 「パートナーQA、商談切り返し、動画・資料マニュアルの案内が可能です」と回答。\n2. 挨拶: 端的に返す。\n3. 不適切: 拒否する。\n4. フォーマット: **太字**使用。リンクは[こちら](URL)形式。`;

            if (score >= THRESHOLDS.CONFIDENCE) {
                prompt = `あなたは営業パートナー支援AIです。以下の[参考情報]を元に回答してください。URLがあれば必ず案内してください。\n\n[参考情報]\n${bestContext.displayText}\n\n[ユーザーの質問]\n${text}\n${commonInstruction}`;
            } else if (score >= THRESHOLDS.SUGGESTION) {
                prompt = `あなたは営業パートナー支援AIです。完全一致しませんでしたが、近い資料が見つかりました。「もしかしてこちらですか？」と提案してください。\n\n[近い資料]\n${bestContext.displayText}\n\n[ユーザーの質問]\n${text}\n${commonInstruction}`;
            } else {
                prompt = `あなたは営業パートナー支援AIです。関連資料は見当たりませんでしたが、ルールに従って回答してください。業務的な質問で答えられない場合は謝罪してください。\n\n[ユーザーの質問]\n${text}\n${commonInstruction}`;
            }

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${CONFIG.geminiApiKey}`;
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });

            const data = await response.json();
            loadingDiv.remove();

            if (data.error) {
                addMessage(`システムエラー: ${data.error.message}`, 'system');
            } else {
                let answer = data.candidates?.[0]?.content?.parts?.[0]?.text || "すみません、回答を生成できませんでした。";
                const disclaimer = '<div style="display:block; margin-top:10px; padding-top:8px; border-top:1px solid rgba(0,0,0,0.1); font-size:11px; color:#888; line-height:1.4;">※回答は必ずしも正しいとは限りません。重要な情報は事務局まで確認するようにしてください。</div>';
                addMessage(answer, 'bot', disclaimer);
            }
        } catch (err) {
            loadingDiv.remove();
            console.error(err);
            addMessage("通信エラーが発生しました。", 'system');
        }
    }

    function init() {
        loadUserPreferences();
        els.input.addEventListener('input', (e) => { state.searchText = e.target.value; renderView(); });
        window.addEventListener('resize', updateLayoutMetrics);
        fetchAllData();
        setInterval(fetchAllData, CONFIG.refreshInterval);
    }

    document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>